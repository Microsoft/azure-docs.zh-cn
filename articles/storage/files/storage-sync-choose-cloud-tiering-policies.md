---
title: 选择 Azure 文件同步云分层策略 |Microsoft Docs
description: 详细了解在选择 Azure 文件同步云分层策略时要注意的事项。
author: roygara
ms.service: storage
ms.topic: conceptual
ms.date: 1/24/2021
ms.author: rogarana
ms.subservice: files
ms.openlocfilehash: 2ed1b8162c49ccc26cb98dd02897a9c40f809d14
ms.sourcegitcommit: dda0d51d3d0e34d07faf231033d744ca4f2bbf4a
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/05/2021
ms.locfileid: "102204307"
---
# <a name="choose-cloud-tiering-policies"></a>选择云分层策略

本文为选择和调整云分层策略的用户提供了指导。 在阅读本文之前，请确保了解云分层的工作原理。 有关云分层基础知识，请参阅 [了解 Azure 文件同步云分层](storage-sync-cloud-tiering-overview.md)。 有关包含示例的云分层策略的详细说明，请参阅 [Azure 文件同步云分层策略](storage-sync-cloud-tiering-policy.md)。

## <a name="limitations"></a>限制
- Windows 系统卷上不支持云分层。

- 如果有卷级 FSRM 配额，仍可启用云分层。 设置 FSRM 配额后，被调用的可用空间查询 Api 将根据配额设置自动报告卷上的可用空间。 

### <a name="minimum-file-size-for-a-file-to-tier"></a>要分层的文件的最小文件大小

对于代理版本9和更高版本，文件到层级的最小文件大小基于文件系统群集大小。 适用于云分层的最小文件大小以2倍的群集大小计算，最低 8 KB 计算。 下表根据卷群集大小说明了可以分层的最小文件大小：

|卷群集大小 (字节)  |此大小或更大的文件可以分层  |
|----------------------------|---------|
|4 KB 或更小的 (4096)       | 8 KB    |
|8 KB (8192)                  | 16 KB   |
|16 KB (16384)                | 32 KB   |
|32 KB (32768)                | 64 KB   |
|64 KB (65536)     | 128 KB  |

当前支持的群集大小为 64 KB，但对于较大的大小，云分层不起作用。

Windows 使用的所有文件系统将基于群集大小的硬盘组织 (也称为分配单元大小) 。 群集大小表示可用于保存文件的最小磁盘空间量。 如果文件大小不能超过群集大小的偶数倍，则必须使用额外的空间来保存到群集大小的下一个多个空间。

Windows Server 2012 R2 和更高版本的 NTFS 卷支持 Azure 文件同步。 下表介绍了使用 Windows Server 2019 创建新的 NTFS 卷时的默认群集大小。

|卷大小    |Windows Server 2019             |
|---------------|--------------------------------|
|7 MB – 16 TB   | 4 KB                |
|16TB – 32 TB   | 8 KB                |
|32TB – 64 TB   | 16 KB               |
|64TB – 128 TB  | 32 KB               |
|128TB – 256 TB | 64 KB（早期最大值） |
|256 TB – 512 TB| 128 KB              |
|512 TB – 1 PB  | 256 KB              |
|1 PB-2 PB    | 512 KB              |
|2 TB – 4 PB    | 1024 KB             |
|4 TB – 8 TB    | 2048 KB（最大大小）  |
|> 8 TB         | 不支持       |

创建卷时，可以使用其他群集大小手动格式化该卷。 如果卷源自较早版本的 Windows，则默认群集大小也可能不同。 [本文详细介绍了默认群集大小。](https://support.microsoft.com/help/140365/default-cluster-size-for-ntfs-fat-and-exfat) 即使选择了小于 4 KB 的群集大小，也可以分层的最小文件大小的 8 KB 限制。 即使在技术上，2 KB 的群集大小将等于小于 8 KB，也 (。 ) 

NTFS 存储极小的文件（1 KB 到 4 KB 大小的文件）的方式中提供了绝对最小值的原因。 根据卷的其他参数，可能不会在磁盘上的群集中存储较小的文件。 将此类文件直接存储在卷的主文件表或 "MFT 记录" 中可能更有效。 云分层重新分析点始终存储在磁盘上，并且仅占用一个群集。 分层此类小文件最终可能无空间节约。 极端情况下，可能会在启用云分层的情况下使用更多空间。 为避免这种情况，云分层将分层的文件的最小大小为 4 kb 或更小的群集大小的 8 KB。 

## <a name="selecting-your-initial-policies"></a>选择初始策略

通常，在服务器终结点上启用云分层时，应为每个单独的服务器终结点创建一个本地虚拟驱动器。 隔离服务器终结点可让你更轻松地了解云分层的工作方式，并相应地调整策略。 但是，即使在同一驱动器上有多个服务器终结点，Azure 文件同步仍有效，有关详细信息，请参阅 " [本地卷上的多个服务器终结点](storage-sync-cloud-tiering-policy.md#multiple-server-endpoints-on-a-local-volume) " 部分。 我们还建议，在你首次启用云分层时，请将 "禁用日期策略" 和 "卷可用空间" 策略设置为大约10% 到20%。 对于大多数文件服务器卷，通常最好选择20% 卷可用空间。

为简单起见，若要清楚地了解项目的分层方式，我们建议你主要调整卷可用空间策略，并保留禁用日期策略（除非需要）。 我们建议这样做，因为大多数客户会发现，用尽可能多的热文件填充本地缓存并将 rest 层级置于云中非常有用。 但是，如果你想要主动释放本地磁盘空间，并且知道在你的日期策略中指定的天数不需要保存在本地时访问的服务器终结点中的文件，则日期策略可能会很有用。 设置日期策略可释放相同卷上的其他终结点的宝贵本地磁盘容量，以缓存其更多的文件。

设置策略后，监视出口并相应地调整两个策略。 建议在 Azure Monitor 中通过应用程序指标专门查看 **云分层召回大小** 和 **云分层召回大小** 。 若要了解如何监视出口，请参阅 [监视云分层](storage-sync-monitor-cloud-tiering.md)。

## <a name="adjusting-your-policies"></a>调整策略

如果从 Azure 中经常回调的文件量大于你的需要，则可能会有比你在本地服务器卷上保存这些文件所需空间更多的文件。 如果可能，请增加本地卷的大小，并/或以较小增量降低卷可用空间策略百分比。 减小卷可用空间百分比太多也可能会产生负面影响。 数据集的更高改动需要更多的可用空间-用于新文件和撤回 "冷" 文件。 在中进行分层时，延迟最多一小时，然后需要处理时间，这就是为什么你应该始终在卷上拥有充足的可用空间。

将更多数据保持在本地意味着更低的出口成本，因为将从 Azure 中回调更少的文件，但同时还需要更多的本地存储，这会产生费用。 

调整卷可用空间策略时，应将本地保留的数据量取决于以下因素：带宽、数据集的访问模式和预算。 使用低带宽连接时，可能需要更多的本地数据，以确保用户的延迟最小。 反之，可以给定时间段内的变动率为依据。 例如，如果您知道每个月的10% 的数据集发生更改或每月都处于主动访问状态，则可能需要保留 100 GB 本地，以便不会频繁地重新调用文件。 如果卷是 2 TB，则需要保留 5% (或 100 GB) 本地，这表示剩余的95% 是卷可用空间百分比。 但是，您应该为较大的改动时间段添加一个缓冲区，换言之，从更大的可用空间百分比开始，然后根据需要进行调整。

## <a name="standard-operating-procedures"></a>标准操作过程

- 第一次通过 Azure 文件同步迁移到 Azure 文件时，云分层依赖于初始上传
- 云分层每60分钟检查一次卷可用空间和日期策略的符合性
- 如果迁移文件时使用 Robocopy 上的/LFSM 开关，将允许文件同步和云分层，以在初始上传过程中腾出空间 
- 如果在构造热度地图之前发生分层，则文件将按上次修改时间戳进行分层

## <a name="next-steps"></a>后续步骤
* [规划 Azure 文件同步部署](storage-sync-files-planning.md)
