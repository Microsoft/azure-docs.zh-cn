---
title: 教程：创建具有基于 IP 的后端的公共负载均衡器 - Azure 门户
titleSuffix: Azure Load Balancer
description: 本教程介绍如何创建具有基于 IP 的后端池的公共负载均衡器。
author: asudbring
ms.author: allensu
ms.service: load-balancer
ms.topic: tutorial
ms.date: 3/31/2021
ms.custom: template-tutorial
ms.openlocfilehash: f8174d46d1674e0cf81e36e89f6fb6180091a9b9
ms.sourcegitcommit: 9f4510cb67e566d8dad9a7908fd8b58ade9da3b7
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/01/2021
ms.locfileid: "106123011"
---
# <a name="tutorial-create-a-public-load-balancer-with-an-ip-based-backend-using-the-azure-portal"></a>教程：使用 Azure 门户创建具有基于 IP 的后端的公共负载均衡器

本教程介绍如何创建具有基于 IP 的后端池的公共负载均衡器。 

Azure 负载均衡器的传统部署使用虚拟机的网络接口。 使用基于 IP 的后端时，虚拟机将按 IP 地址添加到后端。

在本教程中，你将了解如何执行以下操作：

> [!div class="checklist"]
> * 创建虚拟网络
> * 创建用于出站连接的 NAT 网关
> * 创建 Azure 负载均衡器
> * 创建基于 IP 的后端池
> * 创建两个虚拟机
> * 测试负载均衡器
## <a name="prerequisites"></a>先决条件

- 具有活动订阅的 Azure 帐户。 [免费创建帐户](https://azure.microsoft.com/free/?WT.mc_id=A261C142F)。

## <a name="create-a-virtual-network"></a>创建虚拟网络

在本部分，你将为负载均衡器、NAT 网关和虚拟机创建虚拟网络。

1. 登录 [Azure 门户](https://portal.azure.com)。

1. 在屏幕的左上方选择“创建资源”>“网络”>“虚拟网络”，或者在搜索框中搜索“虚拟网络”。  

2. 选择“创建”。 

3. 在“创建虚拟网络”  的“基本信息”选项卡中输入或选择以下信息  ：

    | **设置**          | **值**                                                           |
    |------------------|-----------------------------------------------------------------|
    | **项目详细信息**  |                                                                 |
    | 订阅     | 选择 Azure 订阅                                  |
    | 资源组   | 选择“TutorPubLBIP-rg” |
    | **实例详细信息** |                                                                 |
    | 名称             | 输入“myVNet”                                    |
    | 区域           | 选择“(US)美国东部” |

4. 选择“IP 地址”选项卡  ，或选择页面底部的“下一步:  IP 地址”按钮。

5. 在“IP 地址”  选项卡上，输入以下信息：

    | 设置            | 值                      |
    |--------------------|----------------------------|
    | IPv4 地址空间 | 输入“10.1.0.0/16” |

6. 在“子网名称”下，选择词语“默认”。

7. 在“编辑子网”中输入以下信息： 

    | 设置            | 值                      |
    |--------------------|----------------------------|
    | 子网名称 | 输入“myBackendSubnet” |
    | 子网地址范围 | 输入“10.1.0.0/24” |

8. 选择“保存” 。

9. 选择“安全”选项卡。

10. 在“BastionHost”下，选择“启用” 。 输入此信息：

    | 设置            | 值                      |
    |--------------------|----------------------------|
    | Bastion 名称 | 输入“myBastionHost” |
    | AzureBastionSubnet 地址空间 | 输入 **10.1.1.0/27** |
    | 公共 IP 地址 | 选择“新建”。 </br> 对于“名称”，请输入“myBastionIP” 。 </br> 选择“确定”。 |


11. 选择“查看 + 创建”选项卡，或选择“查看 + 创建”按钮。

12. 选择“创建”。
## <a name="create-nat-gateway"></a>创建 NAT 网关

在本部分中，您将创建一个 NAT 网关，并将其分配给您之前创建的虚拟网络中的子网。

1. 在屏幕的左上方，选择“创建资源”>“网络”>“NAT 网关”，或者在搜索框中搜索“NAT 网关” 。

2. 选择“创建”。 

3. 在“创建网络地址转换(NAT)网关”中，在“基本信息”选项卡中输入或选择以下信息 ：

    | **设置**          | **值**                                                           |
    |------------------|-----------------------------------------------------------------|
    | **项目详细信息**  |                                                                 |
    | 订阅     | 选择 Azure 订阅。                                  |
    | 资源组   | 选择“新建”并在文本框中输入 **TutorPubLBIP-rg** 。 </br> 选择“确定”。 |
    | **实例详细信息** |                                                                 |
    | 名称             | 输入“myNATgateway”                                    |
    | 区域           | 选择“(US)美国东部”  |
    | 可用性区域 | 选择“无”。 |
    | 空闲超时（分钟） | 输入“10”。 |

4. 选择“出站 IP”选项卡，或者选择“下一步:出站 IP”按钮（位于页面底部） 。

5. 在“出站 IP”选项卡中，输入或选择以下信息：

    | **设置** | **值** |
    | ----------- | --------- |
    | 公共 IP 地址 | 选择“创建新的公共 IP 地址”。 </br> 在 **名称** 中，输入 **myPublicIP-NAT**。 </br> 选择“确定”。 |

6. 选择“子网”选项卡，或者选择“下一步:子网”按钮（位于页面底部） 。

7. 在“子网”选项卡中，选择“虚拟网络”下拉列表中的“myVNet”  。

8. 选中 **myBackendSubnet** 旁边的复选框。

9. 选择“查看 + 创建”选项卡，或选择页面底部的“查看 + 创建”按钮 。

10. 选择“创建”。
## <a name="create-load-balancer"></a>创建负载均衡器

在本部分中，您将创建标准 Azure 负载均衡器。 

1. 登录到 [Azure 门户](https://portal.azure.com)。
2. 选择“创建资源”。  
3. 在搜索框中，输入“负载均衡器”。 在搜索结果中选择“负载均衡器”。
4. 在“负载均衡器”页上，选择“创建” 。
5. 在“创建负载均衡器”页中，输入或选择以下信息： 

    | 设置                 | 值                                              |
    | ---                     | ---                                                |
    | **项目详细信息** |   |
    | 订阅               | 选择订阅。    |    
    | 资源组         | 选择“TutorPubLBIP-rg”。|
    | **实例详细信息** |   |
    | 名称                   | 输入“myLoadBalancer”                                   |
    | 区域         | 选择“(US)美国东部”。                                        |
    | 类型          | 选择“公共”。                                        |
    | SKU           | 保留默认值“标准”。 |
    | 层          | 保留默认值“区域”。 |
    | **公共 IP 地址** |   |
    | 公共 IP 地址 | 选择“新建”。 </br> 若要使用现有的公共 IP，请选择“使用现有项”。 |
    | 公共 IP 地址名称 | 在文本框中输入 **myPublicIP-LB**。|
    | 可用性区域 | 选择“区域冗余”以创建弹性负载均衡器。 若要创建区域负载均衡器，请选择特定的区域：1、2 或 3 |
    | 添加一个公共 IPv6 地址 | 请选择“否”。 </br> 有关 IPv6 地址和负载均衡器的详细信息，请参阅[什么是适用于 Azure 虚拟网络的 IPv6？](../virtual-network/ipv6-overview.md)  |
    | 路由首选项 | 保留默认值“Microsoft 网络”。 </br> 有关路由首选项的详细信息，请参阅[什么是路由首选项（预览）？](../virtual-network/routing-preference-overview.md)。 |

6. 接受剩余设置的默认值，然后选择“查看 + 创建”。

7. 在“查看 + 创建”选项卡中，选择“创建”。

## <a name="create-load-balancer-resources"></a>创建负载均衡器资源

在本部分中，你将配置：

* 后端地址池的负载均衡器设置。
* 运行状况探测。
* 负载均衡器规则。

### <a name="create-a-backend-pool"></a>创建后端池

后端地址池包含连接到负载均衡器的虚拟 (NIC) 的 IP 地址。 

创建后端地址池 **myBackendPool** 以包含用于对 Internet 流量进行负载均衡的虚拟机。

1. 在左侧菜单中选择“所有服务”，选择“所有资源”，然后在资源列表中选择“myLoadBalancer”。

2. 在“设置”下，依次选择“后端池”、“+ 添加”  。

3. 在“添加后端池”页上，输入或选择以下信息：

    | 设置 | 值 |
    | ------- | ----- |
    | 名称 | 输入“myBackendPool”。 |
    | 虚拟网络 | 选择“myVNet”。 |
    | 后端池配置 | 选择“IP 地址”。 |
    | IP 版本 | 选择“IPv4”。 |

4. 选择 **添加** 。

### <a name="create-a-health-probe"></a>创建运行状况探测器

负载均衡器使用运行状况探测器监视应用的状态。 

运行状况探测器基于 VM 对运行状况检查的响应，在负载均衡器中添加或删除 VM。 

创建名为 **myHealthProbe** 的运行状况探测来监视 VM 的运行状况。

1. 在左侧菜单中选择“所有服务”，选择“所有资源”，然后在资源列表中选择“myLoadBalancer”。

2. 在“设置”下，依次选择“运行状况探测”、“+ 添加”  。
    
    | 设置 | 值 |
    | ------- | ----- |
    | 名称 | 输入 **myHealthProbe**。 |
    | 协议 | 选择“TCP”。 |
    | 端口 | 输入 **80**。|
    | 时间间隔 | 输入 **15** 作为两次探测尝试之间的 **时间间隔**（以秒为单位）。 |
    | 不正常阈值 | 选择 **2**。 |
   
3. 将剩余的字段保留默认设置，然后选择 **添加**。

### <a name="create-a-load-balancer-rule"></a>创建负载均衡器规则

负载均衡器规则用于定义将流量分配给 VM 的方式。 定义传入流量的前端 IP 配置和后端 IP 池以接收流量。 源端口和目标端口在规则中定义。 

在本部分中，你将创建创建负载均衡器规则：

* 该规则名为“myHTTPRule”。
* 在名为“LoadBalancerFrontEnd”的前端中。
* 正在侦听“端口 80”。
* 将负载均衡流量定向到“端口 80”上名为“myBackendPool”的后端 。

1. 在左侧菜单中选择“所有服务”，选择“所有资源”，然后在资源列表中选择“myLoadBalancer”。

2. 在“设置”下，依次选择“负载均衡规则”、“+ 添加”  。

3. 为负载均衡器规则输入或选择以下信息：
    
    | 设置 | 值 |
    | ------- | ----- |
    | 名称 | 输入 **myHTTPRule**。 |
    | IP 版本 | 选择“IPv4” |
    | 前端 IP 地址 | 选择“LoadBalancerFrontEnd” |
    | 协议 | 选择“TCP”。 |
    | 端口 | 输入 **80**。|
    | 后端端口 | 输入 **80**。 |
    | 后端池 | 选择“myBackendPool”。|
    | 运行状况探测 | 选择“myHealthProbe”。 |
    | 会话暂留 | 保留默认值“无”。 |
    | 空闲超时（分钟） | 输入 **15** 分钟。 |
    | TCP 重置 | 选择“启用”。  |
    | 浮动 IP | 选择“已禁用”。  |
    | 出站源网络地址转换 (SNAT) | 选择“(建议)使用出站规则为后端池成员提供对 Internet 的访问权限。” |

4. 将剩余字段保留默认值，然后选择“添加”。

## <a name="create-virtual-machines"></a>创建虚拟机

在本部分中，您将在两个不同的区域（**区域 1** 和 **区域 2**）中创建两个 VM（**myVM1** 和 **myVM2**）。

这些 VM 将添加到先前创建的负载均衡器的后端池中。

1. 在门户的左上方，选择“创建资源” > “计算” > “虚拟机”  。 
   
2. 在“创建虚拟机”中，在“基本信息”选项卡中输入或选择值 ：

    | 设置 | 值                                          |
    |-----------------------|----------------------------------|
    | **项目详细信息** |  |
    | 订阅 | 选择 Azure 订阅 |
    | 资源组 | 选择“TutorPubLBIP-rg” |
    | **实例详细信息** |  |
    | 虚拟机名称 | 输入“myVM1” |
    | 区域 | 选择“(US)美国东部” |
    | 可用性选项 | 选择“可用性区域” |
    | 可用性区域 | 选择“1” |
    | 映像 | 选择“Windows Server 2019 Datacenter” |
    | Azure Spot 实例 | 保留默认值 |
    | 大小 | 选择 VM 大小或采用默认设置 |
    | **管理员帐户** |  |
    | 用户名 | 输入用户名 |
    | 密码 | 输入密码 |
    | 确认密码 | 重新输入密码 |
    | **入站端口规则** |  |
    | 公共入站端口 | 选择“无” |

3. 选择“网络”选项卡，或选择“下一步: **磁盘”，然后选择“下一步:** 网络”。
  
4. 在“网络”选项卡中，选择或输入：

    | 设置 | 值 |
    |-|-|
    | **网络接口** |  |
    | 虚拟网络 | myVNet |
    | 子网 | myBackendSubnet |
    | 公共 IP | 选择“无”。 |
    | NIC 网络安全组 | 选择“高级”|
    | 配置网络安全组 | 选择“新建”。 </br> 在“创建网络安全组”中，在“名称”中输入“myNSG”  。 </br> 在“入站规则”中，选择“+添加入站规则” 。 </br> 在“服务”下，选择“HTTP” 。 </br> 在“优先级”中，输入 **100** 。 </br> 在“名称”下，输入 **myHTTPRule**  </br> 选择“添加” </br> 选择“确定” |
    | **负载均衡**  |
    | 是否将此虚拟机置于现有的负载均衡解决方案之后？ | 选择此复选框。|
    | **负载均衡设置** |
    | 负载均衡选项 | 选择“Azure 负载均衡器”  |
    | 选择负载均衡器 | 选择“myLoadBalancer”  |
    | 选择后端池 | 选择“myBackendPool” |
   
5. 选择“查看 + 创建”。 
  
6. 检查设置，然后选择“创建”。

7. 按照步骤 1 到 6 操作，使用以下值创建一个 VM，所有其他设置均与 **myVM1** 相同：

    | 设置 | VM 2 |
    | ------- | ----- |
    | 名称 |  **myVM2** |
    | 可用性区域 | **2** |
    | 网络安全组 | 选择现有的“myNSG”| 

## <a name="install-iis"></a>安装 IIS

1. 在左侧菜单中选择“所有服务”，选择“所有资源”，然后从资源列表中选择位于“TutorPubLBIP-rg”资源组中的“myVM1”   。

2. 在“概述”页上，选择“连接”，然后选择“Bastion”  。

3. 选择“使用堡垒”按钮。

4. 输入在 VM 创建过程中输入的用户名和密码。

5. 选择“连接”。

6. 在服务器桌面上，导航到“Windows 管理工具” > “Windows PowerShell”。

7. 在 PowerShell 窗口中，运行以下命令以：

    * 安装 IIS 服务器
    * 删除默认的 iisstart.htm 文件
    * 添加显示 VM 名称的新 iisstart.htm 文件：

   ```powershell
    # install IIS server role
    Install-WindowsFeature -name Web-Server -IncludeManagementTools
    
    # remove default htm file
    Remove-Item C:\inetpub\wwwroot\iisstart.htm
    
    # Add a new htm file that displays server name
    Add-Content -Path "C:\inetpub\wwwroot\iisstart.htm" -Value $("Hello World from " + $env:computername)
   ```
8. 关闭与 myVM1 之间的 Bastion 会话。

9. 重复步骤 1 到 7，在 **myVM2** 上安装 IIS 和更新后的 iisstart.htm 文件。

## <a name="test-the-load-balancer"></a>测试负载均衡器

1. 在“概述”屏幕上找到负载均衡器的公共 IP 地址。 在左侧菜单中选择“所有服务”，选择“所有资源”，然后选择“myPublicIP-LB”  。

2. 复制该公共 IP 地址，并将其粘贴到浏览器的地址栏。 IIS Web 服务器的默认页会显示在浏览器上。

   ![IIS Web 服务器](./media/tutorial-load-balancer-standard-zonal-portal/load-balancer-test.png)

若要查看负载均衡器如何将流量分配到 myVM2，请从客户端计算机强制刷新 Web 浏览器。
## <a name="clean-up-resources"></a>清理资源

如果你不打算继续使用此应用程序，请按以下步骤删除虚拟网络、虚拟机和 NAT 网关：

1. 从左侧菜单中，选择“资源组”。

2. 选择“TutorPubLBIP-rg”资源组。

3. 选择“删除资源组”。

4. 输入 **TutorPubLBIP-rg**，然后选择“删除”。

## <a name="next-steps"></a>后续步骤

本教程介绍以下内容：

* 创建了虚拟网络
* 创建了 NAT 网关
* 创建了具有基于 IP 的后端池的负载均衡器
* 测试了负载均衡器

请继续学习下一篇文章，了解如何创建跨区域负载均衡器：
> [!div class="nextstepaction"]
> [使用 Azure 门户创建跨区域 Azure 负载均衡器](tutorial-cross-region-portal.md)
