---
title: 教程：将 Azure 负载均衡器添加到现有的虚拟机规模集 - Azure 门户
description: 在本教程中，了解如何使用 Azure 门户将负载均衡器添加到现有虚拟机规模集。
author: asudbring
ms.author: allensu
ms.service: load-balancer
ms.topic: tutorial
ms.date: 4/21/2021
ms.custom: template-tutorial
ms.openlocfilehash: cb87efe8402d49463d10e25aa79c50fc3b9b4c6e
ms.sourcegitcommit: bd1a4e4df613ff24e954eb3876aebff533b317ae
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/23/2021
ms.locfileid: "107931031"
---
# <a name="tutorial-add-azure-load-balancer-to-an-existing-virtual-machine-scale-set-using-the-azure-portal"></a>教程：使用 Azure 门户将 Azure 负载均衡器添加到现有的虚拟机规模集

当 Azure 负载均衡器未与虚拟机规模集关联时，可能有此需求。 

你可能当前已有虚拟机规模集部署了 Azure 负载均衡器，而该均衡器需要更新。

可使用 Azure 门户来添加或更新与虚拟机规模集关联的 Azure 负载均衡器。  

在本教程中，你将了解如何执行以下操作：

> [!div class="checklist"]
> * 创建虚拟网络
> * 创建用于出站连接的 NAT 网关
> * 创建标准 SKU Azure 负载均衡器
> * 创建没有负载均衡器的虚拟机规模集
> * 向虚拟机规模集添加 Azure 负载均衡器

## <a name="prerequisites"></a>先决条件

- 具有活动订阅的 Azure 帐户。 [免费创建帐户](https://azure.microsoft.com/free/?WT.mc_id=A261C142F)

## <a name="create-a-virtual-network"></a>创建虚拟网络

在此部分，你将为本教程使用的规模集和其他资源创建一个虚拟网络。

1. 登录到 [Azure 门户](https://portal.azure.com)。

2. 在门户顶部的搜索框中，输入“虚拟网络”。

3. 在搜索结果中，选择“虚拟网络”。

4. 选择“+ 新建”。 

5. 在“创建虚拟网络”的“基本信息”选项卡中输入或选择以下信息 ：

    | 设置 | 值 |
    | ------- | ------|
    | **项目详细信息** |   |
    | 订阅 | 选择订阅。 |
    | 资源组 | 选择“新建”。 </br> 在“名称”中输入“TutorLBVMSS-rg” 。 </br> 选择“确定”。 |
    | **实例详细信息** |   |
    | 名称 | 输入 **myVNet**。 |
    | 区域 | 选择“(US) 美国西部 2”。 |

6. 选择“IP 地址”选项卡，或选择页面底部的“下一页: IP 地址”按钮 。

7. 在“子网名称”下的“IP 地址”选项卡中，选择“默认值”  。

8. 在“子网名称”下的“编辑子网”窗格中，输入 myBackendSubnet  。

9. 选择“保存”。

10. 选择“安全性”选项卡，或者选择“下一页: 安全性”按钮（位于页面底部） 。

11. 在“安全性”选项卡的 BastionHost 中，选择“启用”  。

12. 输入或选择以下信息：

    | 设置 | 值 |
    | ------- | ----- |
    | Bastion 名称 | 输入“MyBastionHost”。 |
    | AzureBastionSubnet 地址空间 | 输入 10.1.1.0/27。 |
    | 公共 IP 地址 | 选择“新建”。 </br> 在“名称”中输入“myBastionIP” 。 |

13. 选择“查看 + 创建”选项卡，或选择页面底部的“查看 + 创建”蓝色按钮 。

14. 选择“创建”。

## <a name="create-nat-gateway"></a>创建 NAT 网关 

此部分将为虚拟机的出站连接创建 NAT 网关。

1. 在门户顶部的搜索框中，输入“NAT 网关”。

2. 在搜索结果中选择“NAT 网关”。

3. 选择“+ 新建”。 

4. 在“创建网络地址转换(NAT)网关”的“基本信息”选项卡中，输入或选择以下值： 

    | 设置 | 值 |
    | ------- | ----- |
    | **项目详细信息** |   |
    | 订阅 | 选择订阅。 |
    | 资源组 | 选择“TutorLBVMSS-rg”。 |
    | **实例详细信息** |   |
    | NAT 网关名称 | 输入 myNATGateway。 |
    | 区域 | 选择“(US) 美国西部 2”。 |
    | 可用性区域 | 选择“无”。 |
    | 空闲超时（分钟） | 输入 **15**。 |

5. 选择“出站 IP”选项卡，或者选择“下一步:出站 IP”按钮（位于页面底部） 。

6. 在“出站 IP”选项卡中，选择“公共 IP 地址”旁边的“创建新的公共 IP 地址”  。

7. 在“名称”中输入 myPublicIP-nat 。

8. 选择“确定”。

9. 选择“子网”选项卡，或者选择“下一步:子网”按钮（位于页面底部） 。

10. 在“虚拟网络”下的下拉菜单中，选择“myVNet” 。

11. 选中 myBackendSubnet 旁边的复选框。

12. 选择“查看 + 创建”选项卡，或选择页面底部的“查看 + 创建”按钮 。

13. 选择“创建”。

## <a name="create-load-balancer"></a>创建负载均衡器

本部分将为虚拟机创建负载均衡器。

1. 在门户顶部的搜索框中，输入“负载均衡器”。

2. 在搜索结果中选择“负载均衡器”。

3. 选择“+ 新建”。 

4. 在“创建负载均衡器”的“基本信息”选项卡中，输入或选择以下信息 ：

    | 设置 | 值 |
    | ------- | ----- |
    | **项目详细信息** |   |
    | 订阅 | 选择订阅。 |
    | 资源组 | 选择“TutorLBVMSS-rg”。 |
    | **实例详细信息** |   |
    | 名称 | 输入 **myLoadBalancer**。 |
    | 区域 | 选择“(US) 美国西部 2”。 |
    | 类型 | 保留默认值“公共”。 |
    | SKU | 保留默认值“标准”。 |
    | 层 | 保留默认值“区域”。 |
    | **公共 IP 地址** |   |
    | 公共 IP 地址 | 保留默认值“新建”。 |
    | 公共 IP 地址名称 | 输入 。 |
    | 可用性区域 | 选择“区域冗余”。 |
    | 添加一个公共 IPv6 地址 | 保留默认值“否”。 |
    | 路由首选项 | 保留默认值“Microsoft 网络”。 |

5. 选择“查看 + 创建”选项卡，或选择页面底部的“查看 + 创建”按钮 。

6. 选择“创建”。

### <a name="configure-load-balancer-settings"></a>配置负载均衡器设置

在此部分，创建 myLoadBalancer 的后端池。

创建一个运行状况探测，以监视 HTTP 和端口 80 。 运行状况探测将监视后端池中虚拟机的运行状况。 

为已禁用出站 SNAT 的端口 80 创建负载均衡规则。 之前创建的 NAT 网关将处理虚拟机的出站连接。

1. 在门户顶部的搜索框中，输入“负载均衡器”。

2. 在搜索结果中选择“负载均衡器”。

3. 选择“myLoadBalancer”。

4. 在“myLoadBalancer”中，选择“设置”中的“后端池”  。

5. 在“后端池”中，选择“+ 添加” 。

6. 在“添加后端池”中，输入或选择以下信息：

    | 设置 | 值 |
    | ------- | ----- |
    | 名称 | 输入“myBackendPool”。 |
    | 虚拟网络 | 选择“myVNet”。 |
    | 后端池配置 | 保留默认值“NIC”。 |
    | IP 版本 | 保留默认值“IPv4”。 |

7. 选择 **添加** 。

8. 选择“运行状况探测”。

9. 选择“+ 添加”。

10. 在“添加运行状况探测”中，输入或选择以下信息：

    | 设置 | 值 |
    | ------- | ----- |
    | 名称 | 输入 myHTTPProbe。 |
    | 协议 | 选择“HTTP”。 |
    | 端口 | 保留默认值“80”。 |
    | 路径 | 保留默认值“/”。 |
    | 时间间隔 | 保留默认值“5 秒”。 |
    | 不正常阈值 | 保留默认值“2 次连续失败”。 |

11. 选择 **添加** 。

12. 选择“负载均衡规则”。 

13. 选择“+ 添加”。

14. 在“添加负载均衡规则”中输入或选择以下信息：

    | 设置 | 值 |
    | ------- | ----- |
    | 名称 | 输入 **myHTTPRule**。 |
    | IP 版本 | 保留默认值“IPv4”。 |
    | 前端 IP 地址 | 选择“LoadBalancerFrontEnd”。 |
    | 协议 | 选择默认值“TCP”。 |
    | 端口 | 输入 **80**。 |
    | 后端端口 | 输入 **80**。 |
    | 后端池 | 选择“myBackendPool”。 |
    | 运行状况探测 | 选择 myHTTPProbe。 |
    | 会话暂留 | 保留默认值“无”。 |
    | 空闲超时（分钟） | 将滑块更改到 15。 |
    | TCP 重置 | 选择“启用”。  |
    | 浮动 IP | 保留默认值“禁用”。 |
    | 出站源网络地址转换 (SNAT) | 保留默认值“(建议)使用出站规则为后端池成员提供对 Internet 的访问权限。” |

5. 选择 **添加** 。

## <a name="create-virtual-machine-scale-set"></a>创建虚拟机规模集

在此部分，你将创建一个没有负载均衡器的虚拟机规模集。 稍后，你将在 Azure 门户中向此规模集添加一个负载均衡器。

1. 在门户顶部的搜索框中，输入“虚拟机规模集”。

2. 在搜索结果中，选择“虚拟机规模集”。

3. 选择“+ 添加”。

4. 在“创建虚拟机规模集”的“基本信息”选项卡中，输入或选择以下信息 ：

    | 设置 | 值 |
    | ------- | ----- |
    | **项目详细信息** |   |
    | 订阅 | 选择订阅。 |
    | 资源组 | 选择“TutorLBVMSS-rg”。 |
    | **规模集详细信息** |   |
    | 虚拟机规模集名称 | 输入“myVMScaleSet”。 |
    | 区域 | 选择“(US) 美国西部 2”。 |
    | 可用性区域 | 保留默认值“无”。 |
    | **业务流程** |   |
    | 业务流程模式 | 保留“已针对包含相同实例的大规模无状态工作负载进行优化”的默认设置。 |
    | **实例详细信息** |   |
    | 映像 | 选择“Windows Server 2019 Datacenter - Gen1”。 |
    | Azure 现成实例 | 保留该框的默认设置，即“未选中”。 |
    | 大小 | 选择一个大小。 |
    | **管理员帐户** |
    | 用户名 | 输入用户名。 |
    | Password | 输入密码。 |
    | 确认密码 | 确认密码。 |

5. 选择“网络”选项卡。

6. 在“网络”选项卡中，输入或选择以下信息：

    | 设置 | 值 |
    | ------- | ----- |
    | **虚拟网络配置** |   |
    | 虚拟网络 | 选择“myVNet”。 |

7. 选择“查看 + 创建”选项卡，或选择页面底部的“查看 + 创建”按钮 。

8. 选择“创建”。

## <a name="add-load-balancer-to-scale-set"></a>向规模集添加负载均衡器

在此部分中，你将在 Azure 门户中转到规模集，并向该规模集添加一个负载均衡器。

1. 在门户顶部的搜索框中，输入“虚拟机规模集”。

2. 在搜索结果中，选择“虚拟机规模集”。

3. 选择“myVMScaleSet”。

4. 在 myVMScaleSet 的“设置”部分，选择“网络”  。

5. 在 myVMScaleSet 的“网络”设置的概述页面中，选择“负载均衡”选项卡   。

    :::image type="content" source="./media/tutorial-add-lb-existing-scale-set-portal/load-balancing-tab.png" alt-text="在“网络”中选择“负载均衡”选项卡。" border="true":::

6. 选择蓝色的“添加负载均衡”按钮。

7. 在“添加负载均衡”中，输入或选择以下信息：

    | 设置 | 值 |
    | ------- | ----- |
    | 负载均衡选项 | 选择“Azure 负载均衡器”。 |
    | 选择负载均衡器 | 选择“myLoadBalancer”。 |
    | 后端池 | 选择“使用现有项”。 |
    | 选择后端池 | 选择“myBackendPool”。 |

8. 选择“保存” 。

## <a name="clean-up-resources"></a>清理资源

如果不打算继续使用此应用程序，请按以下步骤删除负载均衡器和支持资源：

1. 在门户顶部的搜索框中输入“资源组”。

2. 在搜索结果中选择“资源组”。

3. 选择“TutorLBVMSS-rg”。

4. 在 TutorLBVMSS-rg 的概述页面中，选择“删除资源组” 。

5. 在“键入资源组名称”中，输入 TutorLBVMSS-rg 。

6. 选择“删除” 。

## <a name="next-steps"></a>后续步骤

在本教程中，你将了解：

* 创建了虚拟网络和 Azure Bastion 主机。
* 创建了 Azure 标准负载均衡器。
* 创建了一个虚拟机规模集。
* 向虚拟机规模集添加了负载均衡器。

请继续学习下一篇文章，了解如何创建跨区域 Azure 负载均衡器：
> [!div class="nextstepaction"]
> [创建跨区域负载均衡器](tutorial-cross-region-portal.md)