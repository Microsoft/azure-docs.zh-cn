---
title: Azure 上的微服务简介 | Microsoft Docs
description: 概述为何使用微服务方法构建云应用程序对于开发现代应用程序非常重要，以及 Azure Service Fabric 如何提供一个平台用于实现此目的。
services: service-fabric
documentationcenter: .net
author: athinanthny
manager: chackdan
editor: ''
ms.assetid: fae2be85-0ab4-4cd3-9d1f-e0d95fe1959b
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: conceptual
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 04/25/2019
ms.author: atsenthi
ms.openlocfilehash: feb82d2abb756d636aeb77042cc817b7b05f6b0c
ms.sourcegitcommit: 2ce4f275bc45ef1fb061932634ac0cf04183f181
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 05/07/2019
ms.locfileid: "65233654"
---
# <a name="why-a-microservices-approach-to-building-applications"></a>为什么通过微服务的方法构建应用程序？

作为软件开发人员考虑分解成组件部分的应用程序是什么新鲜事物。 通常采用一种分层方法，有后端存储、中间层业务逻辑和前端用户界面 (UI)。 过去几年来的*变化*是身为开发人员的我们，开始为云构建分布式应用程序。

不断变化的业务需求包括：

* 进行构建和运营规模达到新的地理区域中的客户服务。
* 更快速地提供特性与功能，灵活应对客户的需求。
* 提高资源利用率以降低成本。

这些业务要求影响我们*如何*构建应用程序。

有关 Azure 实现微服务的方法的详细信息，请阅读[微服务：由云支持的应用程序变革](https://azure.microsoft.com/blog/microservices-an-application-revolution-powered-by-the-cloud/)。

## <a name="monolithic-vs-microservice-design-approach"></a>单一式设计方法与微服务设计方法

应用程序会随着时间而发展。 成功的应用程序因为有实用性而发展。 失败的应用程序不会发展，最终会被取代。 问题是：多少了解您的要求目前和将来它们将是？ 例如，如果要为某个部门构建报告应用程序。 可以确定的是，应用程序仅在公司范围内适用，而且报表的生存期非常短。 那么，选择的方法将不同于构建服务向数千万个客户传送视频内容的方式。

有时，获取外寻求概念证明才是驱动要素，了解更高版本，可以重新设计应用程序。 过度设计永不使用的功能并没有太大意义。 另一方面，公司谈论构建云时都期望成长和使用量。 问题在于成长和规模不可预测。 我们想要能够原型快速同时还要了解我们正在可以处理未来成功的路上的路径。 这是简练的启动方法：构建、测量、学习和迭代。

在客户端-服务器时代，我们倾向专注于构建分层式应用程序，每一层采用特定的技术。 已针对这些方法派生出“*单一式*”应用程序一词。 接口通常存在于各层之间，而在一层内的各组件之间采用更紧密耦合的设计。 开发人员设计并分解已编译为库并链接为一些可执行文件和 DLL 的类。

这类单一式设计方法有一些优点。 设计较简单，组件之间通常通过进程间通信 (IPC) 调用，因此调用更快。 此外，每个人都只测试单一产品，人力资源运用更有效率。 缺点是分层之间紧密耦合，无法缩放单个组件。 如果需要执行修复或升级，则必须等待其他人完成其测试， 因此更难以发挥灵活性。

微服务解决了这些缺点，更密切配合上述业务要求，但它们本身也都有优缺点。 微服务的优点是通常各自封装较为简单的业务功能，可独立缩放、测试、部署和管理。 微服务方法的一个重要优势是，团队根据业务方案的详细技术。 实际上，较小的团队可以根据客户方案来开发微服务，并采用他们选择的任何技术。

换句话说，组织不需要为了维护微服务应用程序而将技术标准化。 拥有服务的单个团队可以根据团队的专业知识，或什么最适合解决问题，各自发挥所长。 实际上，最好有一组建议的技术，例如特定的 NoSQL 存储或 Web 应用程序框架。

微服务的缺点包括需要管理越来越多的独立实体、处理更复杂的部署和版本控制。 微服务之间的网络流量以及相应的网络延迟不断增加。 经过大量的讨论之后，粒度服务是性能瓶颈的解决良方。 如果没有工具帮助查看这些依赖性，很难“看到”整个系统。

标准通过在通信方式上达成共识，以及只关注需要从服务获得什么来使微服务方法奏效，而不是僵化的约定。 必须在设计的初期定义这些约定，因为之后服务将各自独立更新。 在设计微服务方法时出现的另一个描述是“面向服务的精细体系结构 (SOA)”。

***简而言之，微服务设计方法是分离的服务联合，各自独立更改，并达成一致的通信标准。***

随着越来越多云应用的生成，人们发现从长远来看，这种将整体应用分解成独立、方案焦点式服务的做法是较好的方法。

## <a name="comparison-between-application-development-approaches"></a>应用程序开发方法的比较

![Service Fabric 平台应用程序开发][Image1]

1) 单一式应用包含域特定的功能，通常按照功能层来划分，例如 Web、业务和数据。

2) 单一式应用可通过复制到多个服务器/虚拟机/容器上进行扩展。

3) 微服务应用程序将单个功能分隔成单个较小的服务。

4) 微服务方法可通过独立部署每个服务而扩展，跨服务器/虚拟机/容器创建这些服务的实例。

使用微服务方法进行设计并非所有项目的灵丹妙药，但确实更符合前面所述的业务目标。 如果确定以后有机会根据微服务设计重写代码，可以从单一式方法入手。 更常见的是，从单一式应用程序入手，分阶段慢慢分解它（从需要提高可缩放性或敏捷性的功能区域开始）。

微服务方法是以许多小服务来组成应用程序。 在跨计算机群集的部署的容器中运行这些服务。 较小的团队可针对方案来开发服务，且每个服务独立进行测试、版本控制、部署和缩放，因此整个应用程序可以得到发展。

## <a name="what-is-a-microservice"></a>什么是微服务？

微服务存在多种定义。 但是，大多数微服务的以下特征的广泛接受:

* 封装客户方案或业务方案。 要解决什么问题？
* 由小型工程团队开发。
* 使用任何编程语言编写并使用任何框架。
* 由独立控制版本、部署及缩放的代码和（可选）状态组成。
* 通过定义完善的接口和协议来与其他微服务交互。
* 具有用来解析位置的唯一名称 (URL)。
* 在出现故障时可保持一致且可用。

综上所述：

***微服务应用程序由独立控制版本和可缩放的、以客户为中心的服务组成，这些服务通过标准协议和定义完善的接口彼此通信。***

### <a name="written-in-any-programming-language-and-use-any-framework"></a>使用任何编程语言编写并使用任何框架

作为开发人员，我们应该根据本身的技能或服务需求，自由选择所需的语言或框架。 在某些服务中，可能认为 C++ 的性能优点胜于一切， 而在其他服务中，C# 或 Java 的简易管理开发可能才是最重要的。 在某些情况下，可能需要使用特定合作伙伴库、数据存储技术，或向客户端公开服务的方式。

之后您已选择一种技术，您会操作或生命周期管理和缩放的服务。

### <a name="allows-code-and-state-to-be-independently-versioned-deployed-and-scaled"></a>允许独立控制版本、部署及缩放的代码和状态

无论您选择的方式来编写微服务、 代码，以及 （可选） 状态，应单独部署、 升级和缩放。 这是难以解决的问题之一，因为这涉及到所选的技术。 在缩放方面，难以了解如何分区（或分片）代码和状态。 当代码和状态使用不同的技术时（目前的普遍情况），微服务的部署脚本必须能够妥善缩放两者。 这也关乎到灵活性和弹性，以便可以升级某些微服务，而无需一次性全部升级。

暂时回到单一式方法和微服务方法的比较，下图显示了状态存储方法的差异。

#### <a name="state-storage-between-application-styles"></a>应用程序样式之间的状态存储

![Service Fabric 平台状态存储][Image2]

***左侧的单一式方法具有单一数据库和多层的特定技术。***

***右侧的微服务方法显示互连的微服务图，其中状态通常以微服务为范围，并使用各种技术。***

在单一式方法中，应用程序通常使用单一数据库。 优点是这是单一位置，很容易部署。 每个组件可以通过单个表来存储其状态。 困难之处在于团队必须严格区分状态。 无可避免地就想将新的列添加到现有客户表、在表之间执行联接，并且对存储层形成依赖性。 发生这种情况后，无法缩放各个组件。

在微服务方法中，每个服务都管理并存储自己的状态。 每个服务将负责同时缩放代码和状态，以满足服务的需求。 不足的是，需要创建应用程序数据的视图或查询时，必须跨多个状态存储进行查询。 为了解决此问题，通常由一个独立的微服务构建一个跨许多微服务的视图。 如果需要对数据执行多个即席查询，每个微服务应该考虑将其数据写入数据仓库服务以供脱机分析。

微服务受版本控制，某个微服务的不同版本可能同时运行。 较新版的微服务可能在升级期间失败，并需要回滚到旧版。 版本控制还有助于执行 A/B 式测试，其中不同的用户将体验到不同版本的服务。 例如，在更广泛推出新功能之前，通常先对一组特定的客户升级微服务以测试新功能。

### <a name="interacts-with-other-microservices-over-well-defined-interfaces-and-protocols"></a>通过定义完善的接口和协议来与其他微服务交互

过去 10 年来发布的大量关于面向服务的体系结构的文献对通信模式做了介绍。 一般而言，服务通信使用 REST 方法，并配合 HTTP 与 TCP 协议及 XML 或 JSON 作为序列化格式。 从接口观点来看，这涉及到采用 Web 设计方法。 但仍可以使用二进制协议或自己的数据格式。 如果这些协议和格式非公开可用，微服务使用起来就很难，因此要有心理准备。

### <a name="has-a-unique-name-url-used-to-resolve-its-location"></a>具有用来解析位置的唯一名称 (URL)

微服务无论在何处运行，都必须可寻址。 若要在计算机上运行特定微服务，很快就会陷入困境。

就像 DNS 解析特定计算机的特定 URL 一样，微服务需要有唯一的名称来发现它目前所在的位置。 微服务需要有可寻址的名称才能独立于它们运行所在的基础结构之外。 这意味着服务的部署和发现方式之间互相影响，因为需要有服务注册表。 当计算机发生故障时，注册表服务必须指出服务已移到何处。

### <a name="remains-consistent-and-available-in-the-presence-of-failures"></a>在出现故障时可保持一致且可用

处理意外的故障是最难解决的问题之一，特别是在分布式系统中。 开发人员编写的代码大多是在处理异常，这也是测试时花费最多时间的地方。 问题比编写代码来处理故障更复杂。 当运行微服务的计算机发生故障时，该怎么办？ 不仅需要检测这种故障（本身就是棘手的问题），还需要设法重启微服务。

出于可用性理由，微服务必须能够从故障复原，并能够在另一台计算机上重启。 除了运行中代码的复原能力以外，不应该发生任何数据丢失，并且数据需要保持一致。

如果在应用程序升级期间发生故障，则很难实现复原。 在配合部署系统一起运行时，微服务不仅需要恢复。 它需要确定是要继续升级到更新版本，还是回滚到旧版以维持一致的状态。 需要考虑一些问题，例如，是否有足够的计算机可用于继续升级，以及如何恢复旧版的微服务。 需要微服务发出运行状况信息才能做出这些决定。

### <a name="reports-health-and-diagnostics"></a>报告运行状况和诊断

微服务必须报告其运行状况和诊断，这一点看似明显，但却经常被忽视。 否则，难以从操作角度深入了解其运行状况。 面临的难题是关联一组独立服务的诊断事件并修正计算机时钟偏差以识别事件顺序。 同样地，通过议定的协议和数据格式来与微服务交互时，需要将运行状况和诊断事件的记录方式标准化，这些事件最终将写入可供查询和查看的事件存储。 在微服务方法中，关键在于不同团队同意采用单一记录格式。 需要有一致的方法来查看整个应用程序中的诊断事件。

运行状况与诊断不同。 运行状况是指微服务报告其当前状态，以便采取适当的措施。 一个很好的例子便是使用升级和部署机制来保持可用性。 虽然当前服务可能由于进程崩溃或计算机重新启动而状况不正常，但服务可能仍可运行。 不应该执行升级而让情况恶化。 最好是先进行调查，或让微服务有时间恢复。 微服务中的运行状况事件可以帮助我们制定明智的决策，并且实际上也有助于创建自愈服务。

## <a name="microservices-design-guidance-on-azure"></a>在 Azure 上的微服务设计指南
请访问设计指南的 Azure 体系结构中心[Azure 上构建微服务](https://docs.microsoft.com/azure/architecture/microservices/)

## <a name="service-fabric-as-a-microservices-platform"></a>Service Fabric 作为微服务平台

Microsoft 从提供盒装产品（通常是单一式）转换到提供服务后，Azure Service Fabric 横空问世。 构建和运营 Azure SQL 数据库和 Azure Cosmos DB 等大型服务的经验造就了 Service Fabric。 该平台随着越来越多服务采用它而不断发展变化。 Service Fabric 不仅要在 Azure 中运行，还要在独立的 Windows Server 部署中运行。

***Service Fabric 旨在解决构建和运行服务方面的难题，并有效地利用基础结构资源，使团队可以使用微服务方法来解决业务问题。***

Service Fabric 可帮助你构建使用微服务方法的应用程序，它提供：

* 提供系统服务的平台，用于部署、升级、检测和重启失败的服务、发现服务、路由消息、管理状态和监视运行状况。
* 能够部署在容器中运行或作为进程运行的应用程序。 Service Fabric 是容器和进程 Orchestrator。
* 高效的编程 API，可帮助你将应用程序构建为微服务：[ASP.NET Core、Reliable Actors 和 Reliable Services](service-fabric-choose-framework.md)。 例如，可以获取运行状况和诊断信息，或利用内置的高可用性。

***Service Fabric 与服务生成方式无关，可以使用任意技术。不过，它确实提供内置编程 API，以便用户可以更轻松地生成微服务。***

### <a name="migrating-existing-applications-to-service-fabric"></a>将现有应用程序迁移到 Service Fabric

Service Fabric 允许重用现有代码，可以通过新的微服务对现有代码进行现代化。 应用程序现代化分为五个阶段，可以在任意阶段开始和停止操作。 其中包括：

1) 从传统单一式应用程序入手。  
2) 直接迁移 - 使用容器或来宾可执行文件在 Service Fabric 中托管现有代码。  
3) 现代化 - 将新微服务与现有容器化代码一起添加。  
4) 创新 - 完全根据需求，将单一式应用程序分解成微服务。  
5) 转换为微服务 - 转换现有的单一式应用程序，或生成新领域应用程序。

![迁移到微服务][Image3]

有必要再次强调，可以在其中任一阶段启动和停止。 并不强求继续执行到下一阶段。 现在，让我们来看看每个阶段的示例。

**直接迁移**  
许多公司都出于两个原因，将现有单一式应用程序直接迁移到容器中：

* 由于整合和移除现有硬件或以较高密度运行的应用程序，因此成本降低。
* 开发和运营遵循一致的部署协定。

成本降低可以理解，在 Microsoft 内部，大量现有应用程序正在进行容器化，节省的成本就高达数百万美元。 虽然部署一致性难以评估，但同样很重要。 这意味着，开发者仍可以自由选择适合自己的技术；不过，运营人员只接受使用一种方法来部署和管理这些应用程序。 这样可以减轻运营压力，不必处理许多不同的复杂技术，也不用强制开发者只选择特定技术。 实质上，每个应用程序都容器化到独立式部署映像中。

许多组织止步于这一阶段。 它们已享受到容器带来的优势，Service Fabric 能够提供完整的管理体验，包括部署、升级、版本控制、回滚、运行状况监视等。

**现代化**  
将新服务与现有容器化代码一起添加。 若要编写新代码，最好决定在微服务之旅上略进几步。 可以是添加新的 REST API 终结点，也可以是添加新的业务逻辑。 这样，便可以开始生成新的微服务，并进行开发和部署。

**创新**  
微服务方法可适应不断变化的业务需求。 在此阶段，决策是要将单一式应用拆分为服务，还是进行创新。 当被用作工作流队列的数据库将成为处理瓶颈时，典型的示例。 随着工作流请求数量不断增加，需要分布工作，以实现缩放。 对于不缩放或需要频繁更新的特定应用程序部分，将其分解为微服务，并进行创新。

**转换为微服务**  
这是你的应用程序所在完全组成 （或拆分成） 微服务。 到此，已完成微服务之旅。 虽然可以从此阶段开始，但如果没有微服务平台提供帮助，这会是一项巨额投资。

### <a name="are-microservices-right-for-my-application"></a>微服务适合我的应用程序吗？

也许。 根据我们的经验，随着 Microsoft 中越来越多团队开始出于商业理由而以云为目标来构建，有许多团队都了解到采用类似微服务的方法所带来的优点。 例如，多年以来，必应一直在使用微服务进行开发。 微服务方法对于其他团队而言相当新颖。 团队发现需要解决一些疑难问题，但这并非他们的强项。 这就是为什么 Service Fabric 受到重视而成为构建服务的最佳技术。

Service Fabric 的目标是将构建微服务应用程序的复杂性降低，使你不需要经历许多耗费成本的重新设计工作。 从小规模开始，按需缩放，淘汰旧服务，添加新服务，并随着客户用量的增加而改进。 我们也知道，为了让微服务更易于为大部分开发人员所接受，还有许多其他尚待解决的问题。 容器和执行组件编程模型都是朝此目标前进的一小步，我们确信将涌现出更多的创新来轻松实现目标。


## <a name="next-steps"></a>后续步骤

* [微服务：由云驱动的应用程序革命](https://azure.microsoft.com/blog/microservices-an-application-revolution-powered-by-the-cloud/)
* [Azure 体系结构中心：在 Azure 上构建微服务](https://docs.microsoft.com/azure/architecture/microservices/)
* [Azure Service Fabric 应用程序和群集的最佳做法](service-fabric-best-practices-overview.md)
* [Service Fabric 术语概述](service-fabric-technical-overview.md)

[Image1]: media/service-fabric-overview-microservices/monolithic-vs-micro.png
[Image2]: media/service-fabric-overview-microservices/statemonolithic-vs-micro.png
[Image3]: media/service-fabric-overview-microservices/microservices-migration.png
