---
title: Azure HPC 缓存使用情况模型
description: 介绍不同的缓存使用情况模式，以及如何在其中选择适当的模型来设置只读或读/写缓存并控制其他缓存设置
author: ekpgh
ms.service: hpc-cache
ms.topic: how-to
ms.date: 04/08/2021
ms.author: v-erkel
ms.openlocfilehash: 7e1b11fd15cca9b11fc627222318f08d31743336
ms.sourcegitcommit: 79c9c95e8a267abc677c8f3272cb9d7f9673a3d7
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/19/2021
ms.locfileid: "107719180"
---
# <a name="understand-cache-usage-models"></a>了解缓存使用情况模型

缓存使用情况模型可让你自定义 Azure HPC 缓存存储文件的方式，以加速工作流。

## <a name="basic-file-caching-concepts"></a>文件缓存的基本概念

文件缓存是指 Azure HPC 缓存加速处理客户端请求的方式。 文件缓存采用以下基本做法：

* **读取缓存** - Azure HPC 缓存保留客户端从存储系统请求的文件的副本。 当客户端下次请求同一文件时，HPC 缓存可以提供其缓存中的版本，而无需再次从后端存储系统提取该文件。

* **写入缓存** -（可选）Azure HPC 缓存可以存储从客户端计算机发送的任何已更改文件的副本。 如果在短时间内有多个客户端对同一文件进行了更改，那么缓存可以收集缓存中的所有更改，而无需将每项更改单独写入后端存储系统。

  如果在指定的一段时间后文件未发生更改，缓存会将文件移到长期存储系统。

  如果禁用了写入缓存，缓存将不存储已更改的文件，而是立即将其写入后端存储系统。

* **写回延迟** - 对于启用了写入缓存的缓存，写回延迟是指缓存将文件复制到后端存储系统之前，等待发生进一步的文件更改的时间长短。

* **后端验证** - 后端验证设置确定缓存将其本地文件副本与后端存储系统上的远程版本进行比较的频率。 如果后端副本比缓存的副本要新，则缓存将提取远程副本，并存储该副本以提供给将来的请求。

  后端验证设置显示缓存何时自动将其文件与远程存储中的源文件进行比较。 但是，可以通过执行包含 readdirplus 请求的目录操作，来强制 Azure HPC 缓存比较文件。 readdirplus 是一个标准的 NFS API（也称为扩展读取），它会返回目录元数据，从而使得缓存比较并更新文件。

内置于 Azure HPC 缓存中的使用情况模型对这些设置采用不同的值，以便你可以选择适合你情况的最佳组合。

## <a name="choose-the-right-usage-model-for-your-workflow"></a>为工作流选择适当的使用情况模型

必须为使用的每个 NFS 协议存储目标选择一个使用情况模型。 Azure Blob 存储目标具有一个不可自定义的内置使用情况模型。

HPC 缓存使用情况模型可让你选择如何在快速响应与所获数据过时的风险之间实现平衡。 如果你想要优化文件读取速度，那么你可能不会在意是否根据后端文件检查缓存中的文件。 另一方面，若要确保你的文件始终与远程存储中的文件一样保持最新状态，请选择一个频繁执行检查的模型。

下面是使用情况模型选项：

* **读取量大，写入量少** - 若要加速对静态文件或极少更改的文件的读取访问，请使用此选项。

  此选项会缓存客户端读取，但不缓存写入。 它立即将写入传递到后端存储。
  
  不会自动将缓存中存储的文件与 NFS 存储卷上的文件进行比较。 （请阅读上述后端验证说明以了解如何手动比较文件。）

  如果存在可能会未首先将文件写入缓存便直接在存储系统上修改该文件的风险，请不要使用此选项。 如果发生这种情况，该文件的缓存版本将与后端文件失去同步。

* **写入率超过 15%** - 此选项既可提高读取性能，也可提高写入性能。 使用此选项时，所有客户端必须通过 Azure HPC 缓存访问文件，而不是通过直接装载后端存储来访问。 缓存的文件包含最近所做的、尚未复制到后端的更改。

  在此使用情况模型中，只会每隔八小时根据后端存储中的文件检查缓存中的文件。 假设文件的缓存版本更新。 缓存中已修改的文件如果在缓存中有 20 分钟未发生进一步的更改，将会写入<!-- an hour --> 后端存储系统。

* **客户端写入 NFS 目标并绕过缓存** - 如果工作流中的任何客户端不首先将数据写入缓存便将其直接写入存储系统，或者如果你要优化数据一致性，请选择此选项。 客户端请求（读取）的文件将会缓存，但客户端对这些文件所做的任何更改（写入）不会缓存。 这些更改将直接传递到后端存储系统。

  使用此使用情况模型时，会频繁根据后端版本检查缓存中的文件是否存在更新 - 每隔 30 秒检查一次。 通过这种验证可以在缓存外部更改文件，同时还可保持数据一致性。

  > [!TIP]
  > 这三个基本的使用情况模型可用于处理大多数 Azure HPC 缓存工作流。 接下来的选项适用于不太常见的场景。

* **写入率超过 15%，每隔 30 秒在后备服务器中检查更改** 和 **写入率超过 15%，每隔 60 秒在后备服务器中检查更改** - 这些选项适用于你想要在其中加快读取和写入速度，但有另一用户可能会直接写入后端存储系统的工作流。 例如，如果有多组客户端正在从不同位置处理相同的文件，则这些使用情况模型可能有利于在对快速访问文件的需求与对从源获取过时内容的低容忍度之间实现平衡。

* **写入率超过 15%，每隔 30 秒写回到服务器** - 此选项适用于多个客户端正在活跃修改相同的文件，或者某些客户端直接访问后端存储（而不是装载缓存）的场景。

  频繁的后端写入会影响缓存性能，因此，如果存在文件冲突的风险（低风险），则应考虑使用“写入率超过 15%”使用情况模型 - 例如，如果你知道不同的客户端正在同一文件集的不同区域中工作，则应这样做。

* **读取量大，每隔 3 小时检查后备服务器** - 此选项优先实现客户端上的快速读取，但同时也会定期从后端存储系统刷新已缓存的文件，这不同于“读取量大，写入量小”使用情况模型。

下表汇总了使用情况模型的差异：

[!INCLUDE [usage-models-table.md](includes/usage-models-table.md)]

如果你在哪个使用情况模型最适合你的 Azure HPC 缓存工作流方面有任何疑问，请与 Azure 代表联系，或提出支持请求以获取帮助。

## <a name="know-when-to-remount-clients-for-nlm"></a>了解何时为 NLM 重新装载客户端

在某些情况下，如果更改存储目标的使用模型，则可能需要重新装载客户端。 需要执行此操作是因为不同的使用模型处理网络锁定管理器 (NLM) 请求的方式不同。

HPC 缓存位于客户端与后端存储系统之间。 通常，缓存会将 NLM 请求传递到后端存储系统，但在某些情况下，缓存本身会确认 NLM 请求并向客户端返回值。 在 Azure HPC 缓存中，仅当使用“读取操作频繁，写入操作罕见”这一使用模型（或是具有标准 blob 存储目标，该目标没有可配置的使用模型）时，才会发生这种情况。

如果在“读取操作频繁，写入操作罕见”使用模型与不同使用模型之间进行更改，则存在出现文件冲突的小风险。 无法将当前 NLM 状态从缓存传输到存储系统，反之亦然。 因此，客户端的锁定状态是不准确的。

重新装载客户端可确保它们随新的锁定管理器具有准确的 NLM 状态。

如果客户端在使用模型或后端存储不支持时发送 NLM 请求，则会收到错误。

### <a name="disable-nlm-at-client-mount-time"></a>在客户端装载时禁用 NLM

并非总是可以轻松地了解客户端系统是否会发送 NLM 请求。

在 ``mount`` 命令中使用选项 ``-o nolock``，可在客户端装载群集时禁用 NLM。

``nolock`` 选项的确切行为取决于客户端操作系统，因此请查看客户端操作系统的装载文档 (man 5 nfs)。 在大多数情况下，它会在本地将锁移动到客户端。 如果应用程序跨多个客户端锁定文件，请谨慎使用。

> [!NOTE]
> ADLS-NFS 不支持 NLM。 使用 ADLS-NFS 存储目标时，应使用上述装载选项禁用 NLM。

## <a name="next-steps"></a>后续步骤

* 向 Azure HPC 缓存[添加存储目标](hpc-cache-add-storage.md)
