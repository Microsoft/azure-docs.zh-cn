---
title: Azure 服务总线 - 消息到期时间
description: 本文介绍 Azure 服务总线消息的到期时间和生存时间。 此截止时间过后，将不再传递该消息。
ms.topic: conceptual
ms.date: 02/17/2021
ms.openlocfilehash: 74df8909633c2fa048c23c559ffdd315a8616e11
ms.sourcegitcommit: f3ec73fb5f8de72fe483995bd4bbad9b74a9cc9f
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/04/2021
ms.locfileid: "102042821"
---
# <a name="message-expiration-time-to-live"></a>消息过期时间（生存时间）
消息中的有效负载，或者由消息传递给接收方的命令或查询，几乎总是附带了某种形式的应用程序级过期截止时间。 此截止时间过后，便不再传送内容，或不再执行请求的操作。

对于经常在应用程序或应用程序部件部分运行轮次的上下文中使用队列与主题的开发和测试环境，还需要对滞留的测试消息自动进行垃圾回收，使下一轮测试运行能够从新启动。

可以通过设置 " **生存时间** " 系统属性（该属性指定一个相对持续时间）来控制任何单个消息的过期时间。 在实体中将消息排队后，过期时间即成为一个绝对时刻。 此时， **utc 过期** 时间属性采用 **排队时间-utc** 生存时间值的值  +  。 如果没有正在主动侦听的客户端，则不会强制执行对中转消息的生存时间 (TTL) 设置。

超过 **utc 过期时间时** ，消息将无法进行检索。 过期不会影响当前已锁定以供传递的消息。 这些消息仍会正常处理。 如果锁已过期或者消息被丢弃，则过期时间立即生效。

消息被锁定时，应用程序可以拥有已过期的消息。 应用程序是要继续处理还是选择丢弃消息，则由实施者决定。

在接收方应用程序收到消息之前，毫秒或秒的顺序中的 TTL 极低可能会导致消息过期。 请考虑适用于你的应用程序的最高 TTL。

## <a name="entity-level-expiration"></a>实体级过期时间
发送到队列或主题中的所有消息都服从在实体级别设置的默认过期时间。 还可以在创建期间在门户中设置它，以后再进行调整。 默认的过期时间用于发送到实体的所有消息，其中不会显式设置生存时间。 默认的过期时间也充当生存时间值的上限。 比默认值长的生存时间比默认值长的消息在排队之前会自动调整为默认的消息生存时间值。

> [!NOTE]
> 如果没有另外指定，则中转消息的默认生存时间值为签名64位整数的最大可能值。
>
> 对于队列和主题)  (的消息传递实体，默认的过期时间也是服务总线标准层和高级层的签名64位整数的最大可能值。 对于基本层，默认（也是最大）到期时间为 14 天 。

可以选择将过期消息移到 [死信队列](service-bus-dead-letter-queues.md)。 可以通过编程方式或使用 Azure 门户来配置此设置。 如果保持禁用该选项，将会丢弃已过期的消息。 通过评估 broker 存储在用户属性部分中的 [死信原因](service-bus-dead-letter-queues.md#moving-messages-to-the-dlq) 属性，可以区分移动到死信队列的过期消息。 

在前面所述的例子中，消息已被防止过期并被锁定；如果在实体上设置了相应的标志，则锁被丢弃或过期时，会将该消息移到死信队列。 但是，如果消息成功地进行了结算，则不会移动该消息，因为这会假定应用程序已成功处理该消息，而不考虑名义到期。

生存时间和自动 (和事务性) 过期时间的组合是一种非常有用的工具，可用于在达到截止时间时，检索给定给处理程序的作业或截止时间下的一组处理程序。

例如，假设某个网站需要在规模受限的后端上可靠执行作业，并且偶尔会遇到流量高峰，或者需要受到隔离，以防止该后端在某段时间遇到可用性问题。 在一般情况下，所提交用户数据的服务器端处理程序会将信息推入队列，随后在回复队列中接收确认已成功处理事务的回复。 如果存在流量峰值，并且后端处理程序无法及时处理其积压工作（backlog）项，则将在死信队列中返回过期作业。 可以告知交互用户请求的操作所花费的时间比平时稍长，然后可将请求放到不同队列的处理路径，并通过电子邮件将其中的最终处理结果发送给用户。 


## <a name="temporary-entities"></a>临时实体

可以将服务总线队列、主题和订阅创建为临时实体，在指定的时间段内，这些实体会自动删除。
 
自动清除适用于开发和测试方案，在这些方案中，实体是动态创建的，并且在使用后不会清理，因为存在一些测试或调试运行中断。 当应用程序创建动态实体（例如回复队列）用于在 Web 服务器进程或者生存期相对较短的对象（对象实例消失时难以可靠清理这些实体）中接收响应时，此功能也很有用。

此功能是使用命名空间上的 " **空闲时自动删除** " 属性启用的。 此属性设置为自动删除某个实体之前，该实体必须处于空闲（未使用）状态的持续时间。 此属性的最小值为 5。
 
## <a name="idleness"></a>空闲

下面是被视为实体（队列、主题和订阅）空闲的一些情况：

- 队列
    - 无发送  
    - 无接收  
    - 无队列更新  
    - 无计划的消息  
    - 无浏览/速览 
- 主题  
    - 无发送  
    - 无主题更新  
    - 无计划的消息 
- 订阅
    - 无接收  
    - 无订阅更新  
    - 无添加到订阅的新规则  
    - 无浏览/速览  
 

## <a name="next-steps"></a>后续步骤

若要了解有关服务总线消息传送的详细信息，请参阅以下主题：

* [服务总线队列、主题和订阅](service-bus-queues-topics-subscriptions.md)
* [服务总线队列入门](service-bus-dotnet-get-started-with-queues.md)
* [如何使用服务总线主题和订阅](service-bus-dotnet-how-to-use-topics-subscriptions.md)
