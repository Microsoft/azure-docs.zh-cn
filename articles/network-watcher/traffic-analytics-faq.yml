### YamlMime:FAQ
metadata:
  title: Azure 流量分析常见问题解答 | Microsoft Docs
  description: 获取有关流量分析的常见问题的解答。
  services: network-watcher
  documentationcenter: na
  author: damendo
  ms.service: network-watcher
  ms.devlang: na
  ms.topic: article
  ms.tgt_pltfrm: na
  ms.workload: infrastructure-services
  ms.date: 01/04/2021
  ms.author: damendo
  ms.custom: devx-track-azurepowershell
  ms.openlocfilehash: 5c7503c6f9b4a0d08427e92485b576196edebda1
  ms.sourcegitcommit: c05e595b9f2dbe78e657fed2eb75c8fe511610e7
  ms.translationtype: HT
  ms.contentlocale: zh-CN
  ms.lasthandoff: 06/11/2021
  ms.locfileid: "112034846"
title: 流量分析常见问题解答
summary: >
  本文收集了许多有关 Azure 网络观察程序中流量分析的常见问题。



  [!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]
sections:
- name: 忽略
  questions:
  - question: >
      使用流量分析的先决条件是什么？
    answer: "流量分析要求满足以下先决条件：\n\n- 支持网络观察程序的订阅。\n- 为要监视的网络安全组 (NSG) 启用 NSG 流日志。\n- 用于存储原始流日志的 Azure 存储帐户。\n- 具有读取和写入访问权限的 Azure Log Analytics 工作区。\n\n帐户必须符合以下某项条件才能启用流量分析：\n\n- 帐户必须在订阅范围内具有以下任何一种 Azure 角色：所有者、参与者、读者或网络参与者。\n- 如果未将帐户分配给之前列出的某一角色，则必须在订阅级别将其分配给分配有以下操作的自定义角色。\n            \n    - Microsoft.Network/applicationGateways/read\n    - Microsoft.Network/connections/read\n    - Microsoft.Network/loadBalancers/read \n    - Microsoft.Network/localNetworkGateways/read \n    - Microsoft.Network/networkInterfaces/read \n    - Microsoft.Network/networkSecurityGroups/read \n    - Microsoft.Network/publicIPAddresses/read\n    - Microsoft.Network/routeTables/read\n    - Microsoft.Network/virtualNetworkGateways/read \n    - Microsoft.Network/virtualNetworks/read\n        \n检查针对订阅分配给用户的角色：\n\n1. 使用 Login-AzAccount 登录 Azure。 \n\n2. 使用 Select-AzSubscription 选择所需订阅。 \n\n3. 若要列出分配给特定用户的所有角色，请使用 **Get-AzRoleAssignment -SignInName [user email] -IncludeClassicAdministrators**。 \n\n如果未看到任何输出，请与相应的订阅管理员联系以获取运行命令的权限。 有关详细信息，请参阅[使用 Azure PowerShell 添加或删除 Azure 角色分配](../role-based-access-control/role-assignments-powershell.md)。\n"
  - question: >
      启用流日志的 NSG 是否可与工作区位于不同的区域？
    answer: >
      是，这些 NSG 可与 Log Analytics 工作区位于不同区域。
  - question: >
      是否可以在单个工作区中配置多个 NSG？
    answer: >
      是的。
  - question: >
      是否可以使用现有的的工作区？
    answer: >
      是的。 如果选择现有的工作区，请确保已将此工作区迁移到新的查询语言。 如果不想要升级该工作区，则需要创建新的工作区。 有关新查询语言的详细信息，请参阅[将 Azure Monitor 日志升级到新的日志搜索](../azure-monitor/logs/log-query-overview.md)。
  - question: >
      是否可将 Azure 存储帐户放在一个订阅中，并将 Log Analytics 工作区放在另一个订阅中？
    answer: >
      是，可将 Azure 存储帐户置于一个订阅中，而将 Log Analytics 工作区置于另一个订阅中。
  - question: >
      是否可将原始日志存储在不同的订阅中？
    answer: >
      是的。 可以将 NSG 流日志配置为发送到位于不同订阅中的存储帐户，前提是你具有适当的权限，并且该存储帐户与 NSG 位于同一区域。 NSG 和目标存储帐户还必须共享同一个 Azure Active Directory 租户。
  - question: >
      如果由于“未找到”错误而无法为流量分析配置 NSG，该如何解决？
    answer: >
      选择支持的区域。 如果选择不支持的区域，则会收到“未找到”错误。 前文列出了支持的区域。
  - question: >
      如果在 NSG 流日志页显示“无法加载”状态，该如何解决？
    answer: >
      要使流日志记录正常工作，必须注册 Microsoft.Insights 提供程序。 如果不确定是否为订阅注册了 Microsoft.Insights 提供程序，请替换以下命令中的“xxxxx-xxxxx-xxxxxx-xxxx”，并从 PowerShell 运行以下命令：


      ```powershell-interactive

      **Select-AzSubscription** -SubscriptionId xxxxx-xxxxx-xxxxxx-xxxx

      **Register-AzResourceProvider** -ProviderNamespace Microsoft.Insights

      ```
  - question: >
      我已配置解决方案。 为何仪表板上未显示任何信息？
    answer: "首次显示仪表板最长可能需要花费 30 分钟。 解决方案必须先聚合足够的数据以派生有意义的见解。 然后才能生成报告。 \n"
  - question: >
      如果收到以下消息：“在所选时间间隔内在此工作区中未找到任何数据。 尝试更改时间间隔，或者选择其他工作区”，该如何解决？
    answer: "请尝试以下选项：\n- 在上部菜单栏中更改时间间隔。\n- 在上部菜单栏中选择不同的 Log Analytics 工作区。\n- 如果流量分析是最近才启用的，请尝试在 30 分钟后访问它。\n    \n如果问题仍未解决，请在 [User Voice 论坛](https://feedback.azure.com/forums/217313-networking?category_id=195844)中咨询。\n"
  - question: >
      如果收到以下消息：“正在首次分析 NSG 流日志。 此过程可能需要 20-30 分钟才能完成。 请过一段时间回来查看。 2) 如果上述步骤不起作用，并且工作区位于免费 SKU，则在此处检查工作区使用情况，以验证是否超出配额，或者参阅常见问题解答中的其他信息”，该如何解决？
    answer: "出现此消息的可能原因有：\n- 流量分析最近才启用，可能尚未聚合足够的数据，无法获得有意义的见解。\n- 正在使用免费版 Log Analytics 工作区，并且它超出了配额限制。 可能需要使用容量更大的工作区。\n    \n如果问题仍未解决，请在 [User Voice 论坛](https://feedback.azure.com/forums/217313-networking?category_id=195844)中咨询。\n    \n"
  - question: >
      如果收到以下消息：“似乎我们已获得资源数据（拓扑），但没有流信息。 同时，请单击此处查看资源数据，并参阅常见问题解答了解其他信息”，该如何解决？
    answer: >
      仪表板上显示了资源信息，但未显示与流相关的统计信息。 由于资源之间没有通信流，因此可能不显示数据。 请在 60 分钟后重新检查状态。 如果问题仍未解决，并且确信资源之间存在通信流，请在 [User Voice 论坛](https://feedback.azure.com/forums/217313-networking?category_id=195844)中咨询。
  - question: >
      是否可以使用 PowerShell 或 Azure 资源管理器模板或客户端配置流量分析？
    answer: "可使用版本 6.2.1 及以上版本的 Windows PowerShell 配置流量分析。 若要使用 Set cmdlet 为特定 NSG 配置流日志记录和流量分析，请参阅 [Set-AzNetworkWatcherConfigFlowLog](/powershell/module/az.network/set-aznetworkwatcherconfigflowlog)。 若要获取特定 NSG 的流日志记录和流量分析状态，请参阅 [Get-AzNetworkWatcherFlowLogStatus](/powershell/module/az.network/get-aznetworkwatcherflowlogstatus)。\n\n目前，无法使用 Azure 资源管理器模板配置流量分析。\n\n若要使用 Azure 资源管理器客户端配置流量分析，请参阅以下示例。\n\n**Set cmdlet 示例：**\n\n```\n#Requestbody parameters\n$TAtargetUri =\"/subscriptions/<NSG subscription id>/resourceGroups/<NSG resource group name>/providers/Microsoft.Network/networkSecurityGroups/<name of NSG>\"\n$TAstorageId = \"/subscriptions/<storage subscription id>/resourcegroups/<storage resource group name> /providers/microsoft.storage/storageaccounts/<storage account name>\"\n$networkWatcherResourceGroupName = \"<network watcher resource group name>\"\n$networkWatcherName = \"<network watcher name>\"\n\n$requestBody = \n@\"\n{\n    'targetResourceId': '${TAtargetUri}',\n    'properties': \n    {\n        'storageId': '${TAstorageId}',\n        'enabled': '<true to enable flow log or false to disable flow log>',\n        'retentionPolicy' : \n        {\n            days: <enter number of days like to retail flow logs in storage account>,\n            enabled: <true to enable retention or false to disable retention>\n        }\n    },\n    'flowAnalyticsConfiguration':\n    {\n                'networkWatcherFlowAnalyticsConfiguration':\n      {\n        'enabled':,<true to enable traffic analytics or false to disable traffic analytics>\n        'workspaceId':'bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb',\n        'workspaceRegion':'<workspace region>',\n        'workspaceResourceId':'/subscriptions/<workspace subscription id>/resourcegroups/<workspace resource group name>/providers/microsoft.operationalinsights/workspaces/<workspace name>'\n        \n      }\n\n    }\n}\n\"@\n$apiversion = \"2016-09-01\"\n\narmclient login\narmclient post \"https://management.azure.com/subscriptions/<NSG subscription id>/resourceGroups/<network watcher resource group name>/providers/Microsoft.Network/networkWatchers/<network watcher name>/configureFlowlog?api-version=${apiversion}\" $requestBody\n```\n\n**Get cmdlet 示例：**\n\n```\n#Requestbody parameters\n$TAtargetUri =\"/subscriptions/<NSG subscription id>/resourceGroups/<NSG resource group name>/providers/Microsoft.Network/networkSecurityGroups/<NSG name>\"\n\n\n$requestBody = \n@\"\n{\n    'targetResourceId': '${TAtargetUri}'\n}\n“@\n\n\narmclient login\narmclient post \"https://management.azure.com/subscriptions/<NSG subscription id>/resourceGroups/<network watcher resource group name>/providers/Microsoft.Network/networkWatchers/<network watcher name>/queryFlowLogStatus?api-version=${apiversion}\" $requestBody\n```\n"
  - question: >
      流量分析如何计费？
    answer: "流量分析是计量式的。 该计量的基础是由服务处理流日志数据，并将生成的增强日志存储在 Log Analytics 工作区中。 \n\n例如，根据[定价计划](https://azure.microsoft.com/pricing/details/network-watcher/)，就美国中西部地区而言，如果流量分析处理的存储帐户中存储的流日志数据为 10 GB，而 Log Analytics 工作区中引入的增强日志为 1 GB 则适用的费用是：10 x 2.3$ + 1 x 2.76$ = 25.76$\n"
  - question: >
      流量分析多久处理一次数据？
    answer: >
      请参阅“流量分析架构和数据聚合”文档中的[“数据聚合”部分](./traffic-analytics-schema.md#data-aggregation)
  - question: "流量分析如何确定 IP 是恶意 IP？ \n"
    answer: >
      流量分析依靠 Microsoft 内部威胁智能系统来确定某个 IP 是否为恶意 IP。 这些系统利用各种遥测源，例如 Microsoft 产品和服务、Microsoft 的反数字犯罪部门 (DCU)、Microsoft 安全响应中心 (MSRC) 和外部馈送，并在此基础上构建大量智能。 其中一些数据是 Microsoft 内部数据。 如果已知 IP 被标记为恶意 IP，请提出支持票证以了解详细信息。
  - question: >
      如何针对流量分析数据设置警报？
    answer: "流量分析没有对警报的内置支持。 但是，由于流量分析数据存储在 Log Analytics 中，因此可以编写自定义查询并对其设置警报。 步骤：\n- 可以在流量分析中使 Log Analytics 的短链接。 \n- 使用[此处记录的架构](traffic-analytics-schema.md)编写查询 \n- 单击“新建警报规则”以创建警报\n- 请参阅[日志警报文档](../azure-monitor/alerts/alerts-log.md)以创建警报\n"
  - question: >
      如何检查哪些 VM 接收的本地流量最多？
    answer: "```\nAzureNetworkAnalytics_CL\n| where SubType_s == \"FlowLog\" and FlowType_s == \"S2S\" \n| where <Scoping condition>\n| mvexpand vm = pack_array(VM1_s, VM2_s) to typeof(string)\n| where isnotempty(vm) \n| extend traffic = AllowedInFlows_d + DeniedInFlows_d + AllowedOutFlows_d + DeniedOutFlows_d // For bytes use: | extend traffic = InboundBytes_d + OutboundBytes_d \n| make-series TotalTraffic = sum(traffic) default = 0 on FlowStartTime_t from datetime(<time>) to datetime(<time>) step 1m by vm\n| render timechart\n```\n\n  对于 IP：\n\n```\nAzureNetworkAnalytics_CL\n| where SubType_s == \"FlowLog\" and FlowType_s == \"S2S\" \n//| where <Scoping condition>\n| mvexpand IP = pack_array(SrcIP_s, DestIP_s) to typeof(string)\n| where isnotempty(IP) \n| extend traffic = AllowedInFlows_d + DeniedInFlows_d + AllowedOutFlows_d + DeniedOutFlows_d // For bytes use: | extend traffic = InboundBytes_d + OutboundBytes_d \n| make-series TotalTraffic = sum(traffic) default = 0 on FlowStartTime_t from datetime(<time>) to datetime(<time>) step 1m by IP\n| render timechart\n```\n\n对于时间，请使用格式：yyyy-mm-dd 00:00:00\n"
  - question: >
      如何查看 VM 从本地计算机接收的流量的标准偏差？
    answer: "```\nAzureNetworkAnalytics_CL\n| where SubType_s == \"FlowLog\" and FlowType_s == \"S2S\" \n//| where <Scoping condition>\n| mvexpand vm = pack_array(VM1_s, VM2_s) to typeof(string)\n| where isnotempty(vm) \n| extend traffic = AllowedInFlows_d + DeniedInFlows_d + AllowedOutFlows_d + DeniedOutFlows_d // For bytes use: | extend traffic = InboundBytes_d + utboundBytes_d\n| summarize deviation = stdev(traffic)  by vm\n```\n\n对于 IP：\n\n```\nAzureNetworkAnalytics_CL\n| where SubType_s == \"FlowLog\" and FlowType_s == \"S2S\" \n//| where <Scoping condition>\n| mvexpand IP = pack_array(SrcIP_s, DestIP_s) to typeof(string)\n| where isnotempty(IP) \n| extend traffic = AllowedInFlows_d + DeniedInFlows_d + AllowedOutFlows_d + DeniedOutFlows_d // For bytes use: | extend traffic = InboundBytes_d + OutboundBytes_d\n| summarize deviation = stdev(traffic)  by IP\n```\n"
  - question: >
      如何使用 NSG 规则检查 IP 对之间哪些端口可以访问（或被阻止）？
    answer: "```\nAzureNetworkAnalytics_CL\n| where SubType_s == \"FlowLog\" and TimeGenerated between (startTime .. endTime)\n| extend sourceIPs = iif(isempty(SrcIP_s), split(SrcPublicIPs_s, \" \") , pack_array(SrcIP_s)),\ndestIPs = iif(isempty(DestIP_s), split(DestPublicIPs_s,\" \") , pack_array(DestIP_s))\n| mvexpand SourceIp = sourceIPs to typeof(string)\n| mvexpand DestIp = destIPs to typeof(string)\n| project SourceIp = tostring(split(SourceIp, \"|\")[0]), DestIp = tostring(split(DestIp, \"|\")[0]), NSGList_s, NSGRule_s, DestPort_d, L4Protocol_s, FlowStatus_s \n| summarize DestPorts= makeset(DestPort_d) by SourceIp, DestIp, NSGList_s, NSGRule_s, L4Protocol_s, FlowStatus_s\n```\n"
  - question: >
      如何在地图视图中使用键盘导航？
    answer: "地图页面包含两个主要部分：\n    \n- **标题**：地图顶部的标题提供用于选择流量分配筛选器（例如，“部署”、“来自国家/地区的流量”和“恶意”）的按钮。 选择某按钮时，将在地图上应用相应的筛选器。 例如，如果选择“活动”按钮，则地图会突出显示部署中的活动数据中心。\n- **地图**：标题下的地图部分显示 Azure 数据中心和国家/地区之间的流量分配。\n    \n### <a name=\"keyboard-navigation-on-the-banner\"></a>标题中的键盘导航\n    \n- 地图页面标题部分默认选择“Azure DC”筛选器。\n- 若要移至另一个筛选器，请使用 `Tab` 或 `Right arrow` 键。 若要向后移动，请使用 `Shift+Tab` 或 `Left arrow` 键。 向前导航是从左到右，然后是从上到下。\n- 按 `Enter` 或 `Down` 箭头键可应用选定的筛选器。 根据选择的筛选器和部署，将在下方的“地图”部分突出显示一个或多个节点。\n- 若要在“标题”与“地图”之间切换，请按 `Ctrl+F6`。\n        \n### <a name=\"keyboard-navigation-on-the-map\"></a>地图中的键盘导航\n    \n- 在标题中选择任一筛选器并按 `Ctrl+F6` 后，焦点将移至地图视图中某个突出显示的节点（“Azure 数据中心”或“国家/地区”） 。\n- 若要移至地图中其他突出显示的节点，请使用 `Tab` 或 `Right arrow` 键向前移动。 使用 `Shift+Tab` 或 `Left arrow` 键向后移动。\n- 若要在地图中选择突出显示的任一节点，可以使用 `Enter` 或 `Down arrow` 键。\n- 选择任一此类节点后，焦点会转移到节点的“信息工具框”。 默认情况下，焦点会转移到“信息工具框”中的关闭按钮。 若要进一步在“框”视图中移动，可分别使用 `Right arrow` 和 `Left arrow` 键向前和向后移动。 按 `Enter` 的效果与在“信息工具框”中选择聚焦的按钮相同。\n- 当焦点位于“信息工具框”时，如果按 `Tab`，则焦点会移至选定节点所在的同一大洲中的终结点。 使用 `Right arrow` 和 `Left arrow` 键可浏览这些终结点。\n- 若要移至其他流终结点或大洲群集，请使用 `Tab` 向前移动，或使用 `Shift+Tab` 向后移动。\n- 焦点位于“大洲群集”时，可以使用 `Enter` 或 `Down` 箭头键突出显示大洲群集中的终结点。 若要在大洲群集的信息框中浏览终结点和使用关闭按钮，可分别使用 `Right arrow` 或 `Left arrow` 键向前或向后移动。 在任一终结点上，可以使用 `Shift+L` 切换到从选定节点到终结点的连接线。 可以再次按 `Shift+L` 以移至所选终结点。\n        \n### <a name=\"keyboard-navigation-at-any-stage\"></a>任何阶段的键盘导航\n    \n- 按 `Esc` 可折叠已展开的选定内容。\n- 按 `Up-arrow` 键可执行按 `Esc` 时所执行的相同操作。 按 `Down arrow` 键可执行按 `Enter` 时所执行的相同操作。\n- 使用 `Shift+Plus` 可以放大，使用 `Shift+Minus` 可以缩小。\n"
  - question: >
      如何在虚拟网络拓扑视图中使用键盘导航？
    answer: "虚拟网络拓扑页面包含两个主要部分：\n    \n- **标题**：虚拟网络拓扑顶部标题提供用于选择流量分布筛选器（例如，“已连接的虚拟网络”、“已断开连接的虚拟网络”和“公共 IP”）的按钮。 选择某按钮时，将在拓扑上应用相应的筛选器。 例如，如果选择“活动”按钮，则拓扑会突出显示部署中的活动虚拟网络。\n- **拓扑**：标题下的拓扑部分显示虚拟网络之间的流量分布。\n    \n### <a name=\"keyboard-navigation-on-the-banner\"></a>标题中的键盘导航\n    \n- 虚拟网络拓扑页面标题部分默认选择“已连接的 VNet”筛选器。\n- 若要移至另一个筛选器，请使用 `Tab` 键向前移动。 若要向后移动，请使用 `Shift+Tab` 键。 向前导航是从左到右，然后是从上到下。\n- 按 `Enter` 可应用选定的筛选器。 根据选择的筛选器和部署，将在下方的“拓扑”部分突出显示一个或多个节点（虚拟网络）。\n- 若要在“标题”与“拓扑”之间切换，请按 `Ctrl+F6`。\n        \n### <a name=\"keyboard-navigation-on-the-topology\"></a>拓扑中的键盘导航\n    \n- 在标题中选择任一筛选器并按 `Ctrl+F6` 后，焦点移至拓扑视图中某个突出显示的节点 (VNet)。\n- 若要移至拓扑视图中其他突出显示的节点，请使用 `Shift+Right arrow` 键向前移动。 \n- 在突出显示的节点上，焦点会移至节点的“信息工具框”。 默认情况下，焦点会移至“信息工具框”中的“更多详细信息”按钮 。 若要进一步在“框”视图中移动，可分别使用 `Right arrow` 和 `Left arrow` 键向前和向后移动。 按 `Enter` 的效果与在“信息工具框”中选择聚焦的按钮相同。\n- 选择任何此类节点时，可通过按 `Shift+Left arrow` 键逐个访问其所有连接。 焦点将移至该连接的“信息工具框”。 在任何时候，都可通过再次按 `Shift+Right arrow`，将焦点移回该节点。\n    \n"
  - question: >
      如何在子网拓扑视图中使用键盘导航？
    answer: "虚拟子网拓扑页面包含两个主要部分：\n    \n- **标题**：虚拟子网拓扑顶部的标题提供用于选择流量分布筛选器（例如“活动”、“中型”和“网关子网”）的按钮。 选择某按钮时，将在拓扑上应用相应的筛选器。 例如，如果选择“活动”按钮，则拓扑会突出显示部署中的活动虚拟子网。\n- **拓扑**：标题下的拓扑部分显示虚拟子网络之间的流量分布。\n    \n### <a name=\"keyboard-navigation-on-the-banner\"></a>标题中的键盘导航\n    \n- 虚拟子网拓扑页面标题部分默认选择“子网”筛选器。\n- 若要移至另一个筛选器，请使用 `Tab` 键向前移动。 若要向后移动，请使用 `Shift+Tab` 键。 向前导航是从左到右，然后是从上到下。\n- 按 `Enter` 可应用选定的筛选器。 根据选择的筛选器和部署，将在“拓扑”部分下面突出显示一个或多个节点（子网）。\n- 若要在“标题”与“拓扑”之间切换，请按 `Ctrl+F6`。\n        \n### <a name=\"keyboard-navigation-on-the-topology\"></a>拓扑中的键盘导航\n    \n- 在标题中选择任一筛选器并按 `Ctrl+F6` 后，焦点移至拓扑视图中某个突出显示的节点（子网）。\n- 若要移至拓扑视图中其他突出显示的节点，请使用 `Shift+Right arrow` 键向前移动。 \n- 在突出显示的节点上，焦点会移至节点的“信息工具框”。 默认情况下，焦点会移至“信息工具框”中的“更多详细信息”按钮 。 若要进一步在“框”视图中移动，可分别使用 `Right arrow` 和 `Left arrow` 键向前和向后移动。 按 `Enter` 的效果与在“信息工具框”中选择聚焦的按钮相同。\n- 选择任何此类节点时，可通过按 `Shift+Left arrow` 键逐个访问其所有连接。 焦点将移至该连接的“信息工具框”。 在任何时候，都可通过再次按 `Shift+Right arrow`，将焦点移回该节点。\n"
  - question: >
      是否支持经典 NSG？
    answer: 否，流量分析不支持经典 NSG。 建议将 IaaS 资源从经典部署模型迁移到 Azure 资源管理器，因为经典资源将[弃用](../virtual-machines/classic-vm-deprecation.md)。 请参阅本文了解[如何迁移](../virtual-machines/migration-classic-resource-manager-overview.md)。
