---
title: Azure Database for PostgreSQL 灵活服务器（预览版）的区域冗余高可用性概述
description: 了解 Azure Database for PostgreSQL 灵活服务器的区域冗余高可用性概念
author: sr-msft
ms.author: srranga
ms.service: postgresql
ms.topic: conceptual
ms.date: 09/22/2020
ms.openlocfilehash: c0d9b6042ae695caa73d926653f237b756bf4971
ms.sourcegitcommit: f28ebb95ae9aaaff3f87d8388a09b41e0b3445b5
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/29/2021
ms.locfileid: "94366717"
---
# <a name="high-availability-concepts-in-azure-database-for-postgresql---flexible-server"></a>Azure Database for PostgreSQL 灵活服务器中的高可用性概念

> [!IMPORTANT]
> Azure Database for PostgreSQL 灵活服务器以预览版提供

Azure Database for PostgreSQL 灵活服务器使用区域冗余服务器部署提供具有自动故障转移功能的高可用性配置。 当采用区域冗余配置进行部署时，灵活服务器会自动在不同的可用性区域中预配和管理备用副本。 使用 PostgreSQL 流式复制时，数据会在同步模式下复制到备用副本服务器。 

区域冗余配置可以在计划内事件（例如用户启动的缩放计算操作）期间以及计划外事件（例如基础硬件和软件故障、网络故障和可用性区域故障）期间启用自动故障转移功能，而不会造成数据丢失。 

:::image type="content" source="./media/business-continuity/concepts-zone-redundant-high-availability-architecture.png" alt-text="区域冗余高可用性"::: 

## <a name="zone-redundant-high-availability-architecture"></a>区域冗余高可用性体系结构

可以选择区域和可用性区域来部署主数据库服务器。 备用副本服务器在不同的可用性区域中进行预配，其配置与主服务器相同，包括计算层、计算大小、存储大小和网络配置。 事务日志使用 PostgreSQL 流式复制以同步模式复制到备用副本。 自动备份会定期从主数据库服务器执行，而事务日志会持续从备用副本存档到备份存储。 

可以在门户上持续监视和报告高可用性配置的运行状况。 区域冗余高可用性的状态如下所示：

| **状态** | **说明** |
| ------- | ------ |
| <b>正在初始化 | 正在创建新的备用服务器 |
| <b>正在复制数据 | 创建备用服务器后，它会与主服务器进行通信。 |
| <b>正常运行 | 复制处于稳定状态且正常运行。 |
| <b>正在进行故障转移 | 数据库服务器正在故障转移到备用服务器。 |
| <b>正在删除备用服务器 | 正在删除备用服务器。 | 
| <b>未启用 | 未启用区域冗余高可用性。  |

## <a name="steady-state-operations"></a>稳定状态操作

PostgreSQL 客户端应用程序使用 DB 服务器名称连接到主服务器。 应用程序读取操作是直接从主服务器进行的，而只有在主服务器和备用副本上保存了数据后，才会向应用程序确认提交和写入操作。 由于这一额外的往返要求，应用程序可以预期写入和提交操作的延迟会增加。 你可以在门户上监视高可用性的运行状况。

:::image type="content" source="./media/business-continuity/concepts-high-availability-steady-state.png" alt-text="区域冗余高可用性 - 稳定状态"::: 

1. 客户端连接到灵活服务器并执行写入操作。
2. 更改将复制到备用站点。
3. 主服务器收到确认。
4. 确认写入/提交操作。

## <a name="failover-process---planned-downtimes"></a>故障转移进程 - 计划内停机时间

计划内停机事件包括 Azure 计划的定期软件更新和次要版本升级。 当配置为高可用性时，这些操作首先应用于备用副本，同时应用程序将继续访问主服务器。 更新备用副本后，主服务器连接将断开，并触发故障转移，这会激活备用副本，使其成为具有相同数据库服务器名称的主服务器。 客户端应用程序必须使用相同的数据库服务器名称重新连接到新的主服务器，并可以恢复其操作。 新的备用服务器将与旧的主服务器建立在同一区域中。 

对于其他用户启动的操作（例如缩放计算或缩放存储），更改将首先应用于备用服务器，然后再应用于主服务器。 目前，连接不会故障转移到备用服务器，因此，在主服务器上执行操作时会导致停机。

### <a name="reducing-planned-downtime-with-managed-maintenance-window"></a>通过托管维护时段减少计划内停机时间

 你可以在喜欢的一天内（数据库上的活动预计较低的情况下）选择 30 分钟的时段来安排 Azure 启动的维护活动。 Azure 维护任务（例如修补或次要版本升级）将在该时段进行。  对于配置为高可用性的灵活服务器，这些维护活动将首先在备用副本上执行，然后才会激活备用副本。 然后，应用程序会重新连接到新的主服务器，并在预配新的备用服务器时恢复其操作。

## <a name="failover-process---unplanned-downtimes"></a>故障转移进程 - 计划外停机时间

计划外停机包括影响数据库可用性的软件 bug 或基础结构组件故障。 监视系统检测到服务器不可用时，将断开与备用副本的复制，并激活备用副本作为主数据库服务器。 客户端可以使用相同的连接字符串重新连接到数据库服务器，并恢复其操作。 总体故障转移时间预计为 60-120 秒。 不过，故障转移时可能需要更长时间，具体取决于故障转移时主数据库服务器中的活动（例如大型事务和恢复时间）。

:::image type="content" source="./media/business-continuity/concepts-high-availability-failover-state.png" alt-text="区域冗余高可用性 - 故障转移"::: 

1. 主数据库服务器关闭，客户端失去数据库连接。 
2. 备用服务器将激活成为新的主服务器。 客户端使用相同的连接字符串连接到新的主服务器。 使客户端应用程序位于与主数据库服务器相同的区域中可以降低延迟并提高性能。
3. 备用服务器建立在与旧主服务器相同的区域中，并启动流式复制。 
4. 建立稳定状态的复制后，客户端应用程序提交和写入操作将在这两个站点上保存数据后得到确认。

## <a name="point-in-time-restore"></a>时点还原 

配置为具有高可用性的灵活服务器会将数据实时复制到备用服务器，以保持最新状态。 主服务器上的任何用户错误（例如意外删除表或不正确的数据更新）都将如实复制到备用副本。 因此，不能使用备用副本恢复此类逻辑错误。 若要从这类错误中恢复，必须从备份执行时间点还原。  使用灵活服务器的时间点还原功能，你可以还原到错误发生前的时间点。 对于配置为高可用性的数据库，将使用用户提供的名称将新的数据库服务器还原为单一区域灵活服务器。 然后，便可以从数据库服务器中导出对象，并将其导入生产数据库服务器。 同样，如果想要克隆数据库服务器以便进行测试和开发，或者出于任何其他目的想要进行还原，则可以执行时间点还原。

## <a name="zone-redundant-high-availability---features"></a>区域冗余高可用性 - 功能

-   备用副本将部署在与主服务器完全相同的 VM 配置（包括 vCore、存储空间、网络设置 (VNET、防火墙)等）中。

-   能够为现有数据库服务器添加高可用性。

-   能够通过禁用高可用性来删除备用副本。

-   能够为主数据库服务器选择可用性区域。

-   能够停止、启动和重新启动主数据库服务器和备用数据库服务器。

-   自动备份从主数据库服务器执行并存储在区域冗余存储中。

-   客户端始终连接到主数据库服务器。

-   能够重新启动服务器以获取任何静态服务器参数更改。
  
-   定期维护活动（例如次要版本升级）首先在备用副本上进行，随后服务将进行故障转移以缩短停机时间。  

## <a name="zone-redundant-high-availability---limitations"></a>区域冗余高可用性 - 限制

-   可突发的计算层不支持高可用性。
-   只有在有多个区域可用的区域中才支持高可用性。
-   由于是同步复制到另一个可用性区域，应用程序的写入和提交操作的延迟可能会有所提高。

-   备用副本不能用于读取查询。

-   故障转移过程可能需要超过 120 秒的时间，具体取决于主服务器上的工作负载和活动。

-   重启主数据库服务器也会重启备用副本。 

-   不支持配置其他只读副本。

-   配置客户启动的管理任务无法在托管维护时段进行计划。

-   计划事件（如缩放计算和缩放存储）先在备用服务器中进行，然后在主服务器中进行。 对于这些计划的操作，服务器不会进行故障转移。 

-  如果使用已配置 HA 的灵活服务器配置逻辑解码或逻辑复制，那么当故障转移到备用服务器时，逻辑复制槽不会复制到备用服务器。  

## <a name="next-steps"></a>后续步骤

-   了解[业务连续性](./concepts-business-continuity.md)
-   了解如何[管理高可用性](./how-to-manage-high-availability-portal.md)
-   了解[备份和恢复](./concepts-backup-restore.md)