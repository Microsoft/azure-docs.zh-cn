---
title: 适用于 Azure IoT 中心的设备更新的安全性 |Microsoft Docs
description: 了解 IoT 中心的设备更新如何确保设备安全更新。
author: lichris
ms.author: lichris
ms.date: 2/11/2021
ms.topic: conceptual
ms.service: iot-hub
ms.openlocfilehash: cf05d5f93180db91658d0e94a23359edd5b0f7ad
ms.sourcegitcommit: b4647f06c0953435af3cb24baaf6d15a5a761a9c
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/02/2021
ms.locfileid: "101662184"
---
# <a name="device-update-security-model"></a>设备更新安全模型

IoT 中心的设备更新提供了一种安全的方法，可用于将设备固件、映像和应用程序的更新部署到 IoT 设备。 工作流提供了一个端到端安全通道，其中包含一个完整的保管环节模型，设备可使用该模型来证明更新受信任、未修改和有意。

设备更新工作流中的每个步骤都通过各种安全功能和过程进行保护，以确保管道中的每个步骤都执行到下一个的安全切换。 设备更新客户端标识并正确管理任何非法的更新请求。 该客户端还会检查每个下载，以确保内容受信任、未修改和被故意。

## <a name="for-solution-operators"></a>对于解决方案运算符

当解决方案操作员将更新导入到其设备更新实例中时，服务将上载并检查更新二进制文件，以确保它们未被恶意用户修改或交换。 验证完成后，设备更新服务将生成包含导入清单和其他元数据的文件哈希的内部 [更新清单](./update-manifest.md) 。 然后，设备更新服务对此更新清单进行签名。

当解决方案操作员请求更新设备时，会将已签名的消息通过受保护的 IoT 中心通道发送到设备。 设备的设备更新代理会将请求的签名验证为可信。 

通过验证更新清单签名来保护生成的任何二进制文件下载。 更新清单包含二进制文件哈希，因此，一旦清单被信任，设备更新代理就会信任这些哈希，并将其与二进制文件进行匹配。 下载并验证了更新二进制文件后，会将其移交给设备上的安装程序。

## <a name="for-device-builders"></a>对于设备构建者

为了确保设备更新服务向下扩展到简单、低性能的设备，安全模式使用原始非对称密钥和原始签名。 它们使用基于 JSON 的格式，如 JSON web 令牌 & JSON Web 密钥。

### <a name="securing-update-content-via-the-update-manifest"></a>通过更新清单保护更新内容

使用两个签名来验证更新清单。 使用由 *签名* 密钥和 *根密钥* 组成的结构创建签名。

设备更新代理具有嵌入的公钥，用于所有设备更新兼容设备。 这些是 *根* 键。 对应的私钥由 Microsoft 控制。

Microsoft 还会生成一个公钥/私钥对，它不包含在设备更新代理中或存储在设备上。 这是 *签名* 密钥。

将更新导入到 IoT 中心的设备更新中时，服务会生成更新清单，服务会使用签名密钥对清单进行签名，并包括签名密钥本身（由根密钥签名）。 将更新清单发送到设备时，设备更新代理会接收以下签名数据：

1. 签名值本身。
2. 用于生成 #1 的算法。
3. 用于生成 #1 的签名密钥的公钥信息。
4. #3 中的公共签名密钥的签名。
5. 用于生成 #3 的根密钥的公钥 ID。
6. 用于生成 #4 的算法。

设备更新代理使用上面定义的信息来验证公共签名密钥的签名是否由根密钥进行签名。 然后，设备更新代理会验证是否已通过签名密钥对更新清单签名进行签名。 如果所有签名均正确，则设备更新代理会信任更新清单。 由于更新清单包含对应于更新文件本身的文件哈希，因此，如果哈希匹配，则还可以信任更新文件。

使用根密钥和签名密钥，Microsoft 可以定期滚动签名密钥，这是最佳安全方案。

### <a name="json-web-signature-jws"></a>JSON Web 签名 (JWS)

`updateManifestSignature`用于确保中包含的信息 `updateManifest` 未被篡改。 `updateManifestSignature`使用带有 Json Web 密钥的 Json Web 签名生成，允许进行源验证。 签名是一个 Base64Url 编码的字符串，其中三个部分由 "." 进行描述。  请参阅用于分析和验证 JSON 密钥和令牌的 jws_util 的帮助器方法。

JSON Web 签名是一种广泛使用的 [建议的 IETF 标准](https://tools.ietf.org/html/rfc7515) ，用于使用基于 JSON 的数据结构对内容进行签名。 通过验证数据的签名可确保数据的完整性。 有关详细信息，请参阅 JSON Web 签名 (JWS) [RFC 7515](https://www.rfc-editor.org/info/rfc7515)。

### <a name="json-web-token"></a>JSON Web 令牌

JSON Web 令牌是开放的行业 [标准](https://tools.ietf.org/html/rfc7519) 方法，可在两方之间安全表示声明。

### <a name="root-keys"></a>根键

每个设备更新设备包含一组根密钥。 对于所有设备更新的签名，这些密钥是信任的根。 任何签名都必须通过其中一个根密钥向上链接，才能被视为合法。

根键集会随时间而改变，因为为了安全起见，需要定期轮换签名密钥。 因此，设备更新代理软件需要使用最新的根密钥集来更新自身。 

### <a name="signatures"></a>签名

所有签名都将由某个根密钥签署 (公共) 密钥进行签名。 签名将标识哪个根密钥用于对签名密钥进行签名。 

设备更新代理必须首先验证签名 (公共) 密钥的签名是否正确，是否有效，并由某个已批准的根密钥签署。 成功验证签名密钥后，可以使用现在信任的签名公钥来验证签名本身。

签名密钥的旋转速度比根键快得多，因此预期消息由各种不同的签名密钥进行签名。 

签名密钥的吊销由设备更新服务进行管理，因此，用户不应尝试缓存签名密钥。 始终使用签名附带的签名密钥。

### <a name="receiving-updates"></a>正在接收更新

设备更新代理收到的更新请求将包含 (UM) 文档的签名更新清单。 代理必须验证 UM 的签名是否正确且不完整。 这是通过验证是否已使用正确的根密钥对 UM 签名的签名密钥进行签名来完成的。 完成后，代理会根据签名密钥对 UM 签名进行验证。

验证 UM 签名后，设备更新代理可能会将其信任为 "事实源"。 所有进一步的安全信任起源于该源。 

UM 包含要下载和安装的内容的 Url 和文件哈希。 代理下载更新二进制文件后，必须根据在 UM 中找到的文件哈希来验证更新。 这为下载验证提供了一个可传递信任模型。 它不仅确保内容完好无损 (未) 修改，还可以确认下载的内容确实是要下载的内容。 

### <a name="securing-the-device"></a>保护设备

务必确保设备上的设备更新相关安全资产得到适当的保护和保护。 需要保护根密钥等资产以防止修改。 有多种方法可以实现此目的，例如使用安全设备 (TPM、SGX、HSM、其他安全设备) 甚至在设备更新代理中对其进行硬编码。 后者要求设备更新代理代码已进行数字签名，并且系统的代码完整性支持可防止恶意的代理代码修改。

可以保证其他安全措施，例如确保以安全的方式执行从组件到组件的切换。 例如，注册特定的独立帐户以运行不同的组件。 和限制基于网络的通信 (例如 REST API 仅向 localhost) 调用。

**[下一步：了解有关设备更新如何使用 Azure RBAC 的详细信息](.\device-update-control-access.md)**