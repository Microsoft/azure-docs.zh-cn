---
title: include 文件
description: include 文件
services: virtual-machines
author: albecker1
ms.service: virtual-machines
ms.topic: include
ms.date: 10/12/2020
ms.author: albecker1
ms.custom: include file
ms.openlocfilehash: 086ebf71e2da19a96433f32cfb1bae133e875400
ms.sourcegitcommit: 59f506857abb1ed3328fda34d37800b55159c91d
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 10/24/2020
ms.locfileid: "92518040"
---
![显示 D s v 3 规范的图表。](media/vm-disk-performance/dsv3-documentation.jpg)

- 最大非 *缓存* 磁盘吞吐量是虚拟机可处理的默认存储最大限制。
- 启用主机缓存后，最大 *缓存* 存储吞吐量限制是单独的限制。

主机缓存的工作原理是：使存储空间更接近可以写入或读取的 VM。 可供 VM 用于主机缓存的存储量位于文档中。 例如，你可以看到 Standard_D8s_v3 附带了 200 GiB 的缓存存储。

你可以在创建虚拟机时启用主机缓存并附加磁盘。 你还可以在现有 VM 上打开和关闭磁盘上的主机缓存。

![显示主机缓存的屏幕截图。](media/vm-disk-performance/host-caching.jpg)

可以调整主机缓存，使其符合每个磁盘的工作负荷要求。 可以将主机缓存设置为：

- **只读**：适用于仅执行读取操作的工作负荷
- **读/写**：适用于对读取和写入操作进行平衡的工作负荷

如果你的工作负荷不遵循上述任一模式，则建议你不要使用主机缓存。

让我们通过几个示例来了解不同的主机缓存设置，以了解它是如何影响数据流和性能的。 在第一个示例中，将在 "主机缓存" 设置设置为 **只读**时，查看 IO 请求发生了什么情况。

**程序**

- Standard_D8s_v3
  - 缓存的 IOPS：16000
  - 未缓存 IOPS：12800
- P30 数据磁盘
  - IOPS：5000
  - 主机缓存： **只读**

当执行读取，并且所需的数据在缓存上可用时，缓存将返回所请求的数据。 无需从磁盘读取。 此读取将计入 VM 的缓存限制。

![显示读取主机缓存读取命中的关系图。](media/vm-disk-performance/host-caching-read-hit.jpg)

当执行读取，并且所需的数据在缓存中 *不可用时* ，读取请求将中继到该磁盘。 然后，磁盘将其呈现给缓存和 VM。 此读取将计入 VM 的未缓存限制和 VM 的缓存限制。

![显示读取主机缓存读取未命中的关系图。](media/vm-disk-performance/host-caching-read-miss.jpg)

执行写入时，必须将写入写入缓存和磁盘，然后才能将其视为已完成。 此写入会计入 VM 的未缓存限制和 VM 的缓存限制。

![显示读取主机缓存写入的关系图。](media/vm-disk-performance/host-caching-write.jpg)

接下来，让我们看看在将主机缓存设置为 **读/写**时 IO 请求发生了什么情况。

**程序**

- Standard_D8s_v3
  - 缓存的 IOPS：16000
  - 未缓存 IOPS：12800
- P30 数据磁盘
  - IOPS：5000
  - 主机缓存： **读/写**

读取是以与只读相同的方式处理的。 写入只是与读/写缓存不同的内容。 当用主机缓存进行写入时，将设置为 **读/写**，只需将写入写入主机缓存即可完成。 然后，将该写入作为后台进程延迟写入磁盘。 这意味着写入缓存时写入缓存的 IO。 如果它被延迟写入磁盘，则会计入未缓存的 IO。

![显示读取/写入主机缓存写入的关系图。](media/vm-disk-performance/host-caching-read-write.jpg)

接下来，我们 Standard_D8s_v3 的虚拟机。 但在这种情况下，我们会在磁盘上启用主机缓存。 而且，现在 VM 的 IOPS 限制为 16000 IOPS。 附加到 VM 的是三个基础 P30 磁盘，每个磁盘可处理 5000 IOPS。

**程序**

- Standard_D8s_v3
  - 缓存的 IOPS：16000
  - 未缓存 IOPS：12800
- P30 OS 磁盘
  - IOPS：5000
  - 主机缓存： **读/写**
- 两个 P30 数据磁盘×2
  - IOPS：5000
  - 主机缓存： **读/写**

![显示主机缓存示例的关系图。](media/vm-disk-performance/host-caching-example-without-remote.jpg)

应用程序使用已启用缓存的 Standard_D8s_v3 虚拟机。 它发出 15000 IOPS 的请求。 对于每个连接的基础磁盘，请求将分解为 5000 IOPS。 不会进行性能上限。

## <a name="combined-uncached-and-cached-limits"></a>合并缓存和缓存限制

虚拟机的缓存限制与缓存限制不同。 这意味着，可以在附加到 VM 的磁盘上启用主机缓存，同时不在其他磁盘上启用主机缓存。 此配置允许虚拟机获取缓存的限制和未缓存的限制的总存储 IO。

让我们通过一个示例来帮助你了解这些限制如何协同工作。 我们将继续 Standard_D8s_v3 虚拟机和高级磁盘附加配置。

**程序**

- Standard_D8s_v3
  - 缓存的 IOPS：16000
  - 未缓存 IOPS：12800
- P30 OS 磁盘
  - IOPS：5000
  - 主机缓存： **读/写**
- 两个 P30 数据磁盘×2
  - IOPS：5000
  - 主机缓存： **读/写**
- 两个 P30 数据磁盘×2
  - IOPS：5000
  - 主机缓存： **已禁用**

![显示具有远程存储的主机缓存示例的关系图。](media/vm-disk-performance/host-caching-example-with-remote.jpg)

在这种情况下，在 Standard_D8s_v3 的虚拟机上运行的应用程序会请求 25000 IOPS。 对于每个附加磁盘，请求将被分解为 5000 IOPS。 三个磁盘使用主机缓存，两个磁盘不使用主机缓存。

- 由于使用主机缓存的三个磁盘处于缓存限制（16000）之内，因此这些请求已成功完成。 不会进行存储性能上限。
- 由于不使用主机缓存的两个磁盘处于未缓存的12800限制内，因此这些请求也已成功完成。 不发生上限。

## <a name="disk-performance-metrics"></a>磁盘性能指标

我们在 Azure 上有一些指标，这些指标可提供有关虚拟机和磁盘的执行情况的见解。 可以通过 Azure 门户查看这些指标。 还可以通过 API 调用来检索它们。 指标按一分钟间隔计算。 以下指标可用于深入了解 VM 和磁盘 IO 以及吞吐量性能：

- **Os 磁盘队列深度**：等待读取或写入 OS 磁盘的当前未完成 IO 请求数。
- **Os 磁盘读取字节数/秒**：从 OS 磁盘中读取的字节数。
- **Os 磁盘读取操作数/秒**：从 OS 磁盘中读取的每秒输入操作的数量。
- **Os 磁盘写入字节数/秒**：从 OS 磁盘写入的字节数。
- **Os 磁盘写入操作数/秒**：从 OS 磁盘写入秒的输出操作数。
- **数据磁盘队列深度**：等待读取或写入数据磁盘)  (的当前未完成 IO 请求数。
- **数据磁盘读取字节数/秒**：从数据磁盘) 读取 (的字节数。
- **数据磁盘读取操作数/秒**：从数据磁盘)  (读取的输入操作数。
- **数据磁盘写入字节数/秒**：从数据磁盘) 写入 (的字节数。
- **数据磁盘写入操作数/秒**：从数据磁盘)  (写入的输出操作数。
- **磁盘读取字节数/秒**：从附加到 VM 的所有磁盘中读取的总字节数。
- **磁盘读取操作数/秒**：从附加到 VM 的所有磁盘中读取的输入操作数。
- **磁盘写入字节数/秒**：每秒从附加到 VM 的所有磁盘写入的字节数。
- **磁盘写入操作次数/秒**：从附加到 VM 的所有磁盘写入的输出操作数。

## <a name="storage-io-utilization-metrics"></a>存储 IO 利用率指标

有助于诊断磁盘 IO 上限的指标：

- **使用的数据磁盘 IOPS 百分比**：通过预配的数据磁盘 iops 完成的数据磁盘 iops 计算得出的百分比。 如果此数量为100%，则运行的应用程序的 IO 限制为数据磁盘的 IOPS 限制。
- **使用的数据磁盘带宽百分比**：通过预配的数据磁盘吞吐量完成的数据磁盘吞吐量计算得出的百分比。 如果此数量为100%，则运行的应用程序的 IO 限制为数据磁盘的带宽限制。
- **使用的 Os 磁盘 IOPS 百分比**：通过预配的 OS 磁盘 iops 完成的 OS 磁盘 iops 计算得出的百分比。 如果此数量为100%，则运行的应用程序的 IO 超出了 OS 磁盘的 IOPS 限制。
- **使用的 Os 磁盘带宽百分比**：通过预配的 os 磁盘吞吐量完成的 os 磁盘吞吐量计算得出的百分比。 如果此数量为100%，则运行的应用程序的 IO 限制为操作系统磁盘的带宽限制。

有助于诊断 VM IO 上限的指标：

- **使用的 VM 缓存 IOPS 百分比**：按最大缓存虚拟机 iops 限制完成的总 iops 计算得出的百分比。 如果此数量为100%，则运行的应用程序的 IO 限制为 VM 的缓存 IOPS 限制。
- 已用**VM 缓存的带宽百分比**：按最大缓存虚拟机吞吐量完成的总磁盘吞吐量计算得出的百分比。 如果此数量为100%，则运行的应用程序的 IO 限制为 VM 的缓存带宽限制。
- **使用的 VM 未缓存 IOPS 百分比**：通过最大非缓存虚拟机 IOPS 限制完成的虚拟机上的总 IOPS 计算得出的百分比。 如果此数量为100%，则你的应用程序运行的 IO 超出了 VM 的未缓存 IOPS 限制。
- **使用的 VM 未缓存带宽百分比**：按最大预配虚拟机吞吐量完成的虚拟机上的总磁盘吞吐量计算得出的百分比。 如果此数量为100%，则你的应用程序运行的 IO 超出了 VM 的未缓存带宽限制。

## <a name="storage-io-utilization-metrics-example"></a>存储 IO 利用率指标示例

让我们通过一个示例来了解如何使用这些新的存储 IO 利用率指标来帮助我们调试系统中的瓶颈。 系统设置与前面的示例相同，只不过这一次 *未* 缓存附加的 OS 磁盘。

**程序**

- Standard_D8s_v3
  - 缓存的 IOPS：16000
  - 未缓存 IOPS：12800
- P30 OS 磁盘
  - IOPS：5000
  - 主机缓存： **已禁用**
- 两个 P30 数据磁盘×2
  - IOPS：5000
  - 主机缓存： **读/写**
- 两个 P30 数据磁盘×2
  - IOPS：5000
  - 主机缓存： **已禁用**
